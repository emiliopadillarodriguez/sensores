<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>BMS · Visor Tendencias S / D</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<style>
:root{
  --bg:#020617;
  --panel:#020617;
  --fg:#e5e7eb;
  --muted:#94a3b8;
  --grid:#1e293b;
  --ok:#22c55e;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,Segoe UI,Arial;
}

header{
  padding:10px;
  border-bottom:1px solid var(--grid);
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

header b{ font-size:14px }

button,input{
  background:#020617;
  border:1px solid var(--grid);
  color:var(--fg);
  padding:6px 10px;
  border-radius:8px;
  font-size:12px;
}

.layout{
  display:grid;
  grid-template-columns:260px 1fr;
  height:calc(100vh - 56px);
}

.sidebar{
  border-right:1px solid var(--grid);
  padding:10px;
  overflow:auto;
}

h3{
  font-size:13px;
  margin:10px 0 6px;
  color:#38bdf8;
}

.item{
  display:flex;
  gap:6px;
  align-items:flex-start;
  font-size:12px;
  margin-bottom:4px;
}

.item label{ cursor:pointer }

.main{
  padding:10px;
}

#chart{
  width:100%;
  height:100%;
}
</style>
</head>

<body>

<header>
  <b>Visor BMS · Tendencias</b>

  Inicio <input type="datetime-local" id="dtStart">
  Fin <input type="datetime-local" id="dtEnd">

  <button onclick="applyRange()">Aplicar</button>
  <button onclick="resetRange()">Reset</button>

  <span id="info" style="margin-left:auto;font-size:12px;color:var(--muted)">—</span>
</header>

<div class="layout">
  <aside class="sidebar">
    <h3>Sensores (S)</h3>
    <div id="listS"></div>

    <h3>Drivers (D)</h3>
    <div id="listD"></div>
  </aside>

  <main class="main">
    <div id="chart"></div>
  </main>
</div>

<script>
/* ========= CONFIG ========= */
const MAX_S = 50;
const MAX_D = 50;
const DATA_DIRS = ["sensores/data","data","./sensores/data","./data"];

let LABELS={S:{},D:{}};
let store={S:new Map(),D:new Map(),range:{},view:{}};
let chart=echarts.init(document.getElementById("chart"));

/* ========= UTIL ========= */
async function fetchTxt(u){
  try{ const r=await fetch(u,{cache:"no-store"}); return r.ok?await r.text():null }catch{return null}
}
async function detectDir(){
  for(const d of DATA_DIRS){
    if(await fetchTxt(`${d}/S1.txt`)||await fetchTxt(`${d}/drv_D1.txt`)) return d;
  }
  return null;
}
function parseS(t){
  return t.split(/\n/).map(l=>{
    const [a,b]=l.split(";"); return [new Date(a).getTime(),Number(b)]
  }).filter(v=>!isNaN(v[0])&&!isNaN(v[1]));
}
function parseD(t){
  return t.split(/\n/).map(l=>{
    const [a,b]=l.split(";"); return [new Date(a).getTime(),String(b).toLowerCase()==="on"?1:0]
  }).filter(v=>!isNaN(v[0]));
}
function getLabel(g,k){ return LABELS[g]?.[k]||k }

/* ========= LOAD ========= */
async function load(){
  const dir=await detectDir();
  if(!dir){ document.getElementById("info").textContent="Datos no encontrados"; return }

  const lbl=await fetchTxt(`${dir}/labels.json`);
  if(lbl) LABELS=JSON.parse(lbl);

  for(let i=1;i<=MAX_S;i++){
    const t=await fetchTxt(`${dir}/S${i}.txt`);
    if(!t) continue;
    const pts=parseS(t);
    if(!pts.length) continue;
    store.S.set(`S${i}`,{pts,selected:false});
  }

  for(let i=1;i<=MAX_D;i++){
    const t=await fetchTxt(`${dir}/drv_D${i}.txt`);
    if(!t) continue;
    const ev=parseD(t);
    if(!ev.length) continue;
    store.D.set(`D${i}`,{ev,selected:false});
  }

  buildLists();
  calcRange();
  render();
}

function calcRange(){
  let all=[];
  store.S.forEach(v=>v.pts.forEach(p=>all.push(p[0])));
  store.D.forEach(v=>v.ev.forEach(e=>all.push(e[0])));
  store.range.min=Math.min(...all);
  store.range.max=Math.max(...all);
  store.view={};
  document.getElementById("info").textContent=
    new Date(store.range.min).toLocaleString()+" → "+
    new Date(store.range.max).toLocaleString();
}

/* ========= LISTS ========= */
function buildLists(){
  const ls=document.getElementById("listS");
  const ld=document.getElementById("listD");

  ls.innerHTML=""; ld.innerHTML="";

  store.S.forEach((v,k)=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`<input type=checkbox>
      <label>${getLabel("S",k)}</label>`;
    d.querySelector("input").onchange=e=>{v.selected=e.target.checked;render()};
    ls.appendChild(d);
  });

  store.D.forEach((v,k)=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`<input type=checkbox>
      <label>${getLabel("D",k)}</label>`;
    d.querySelector("input").onchange=e=>{v.selected=e.target.checked;render()};
    ld.appendChild(d);
  });
}

/* ========= RANGE ========= */
function applyRange(){
  store.view.min=new Date(dtStart.value).getTime();
  store.view.max=new Date(dtEnd.value).getTime();
  render();
}
function resetRange(){
  store.view={};
  render();
}

/* ========= RENDER ========= */
function buildIntervals(ev,min,max){
  let r=[];
  for(let i=0;i<ev.length;i++){
    if(ev[i][1]===1){
      const a=Math.max(ev[i][0],min);
      const b=i+1<ev.length?Math.min(ev[i+1][0],max):max;
      if(b>a) r.push([a,b]);
    }
  }
  return r;
}

function render(){
  const min=store.view.min||store.range.min;
  const max=store.view.max||store.range.max;

  const series=[];
  const yAxis=[];
  const grid=[];

  /* S */
  grid.push({top:30,height:"45%",left:70,right:20});
  yAxis.push({type:"value",gridIndex:0,axisLabel:{color:"#e5e7eb"},splitLine:{lineStyle:{color:"#1e293b"}}});
  store.S.forEach((v,k)=>{
    if(v.selected) series.push({
      name:getLabel("S",k),
      type:"line",
      data:v.pts,
      xAxisIndex:0,
      yAxisIndex:0,
      showSymbol:false
    });
  });

  /* D */
  grid.push({top:"58%",height:"30%",left:70,right:20});
  const dNames=[...store.D.entries()].filter(e=>e[1].selected).map(e=>getLabel("D",e[0]));
  yAxis.push({type:"category",gridIndex:1,data:dNames,axisLabel:{color:"#e5e7eb"}});

  let idx=0;
  store.D.forEach((v,k)=>{
    if(!v.selected) return;
    buildIntervals(v.ev,min,max).forEach(([a,b])=>{
      series.push({
        type:"custom",
        xAxisIndex:0,
        yAxisIndex:1,
        data:[[a,b,idx]],
        renderItem:(p,api)=>{
          const y=api.coord([a,idx])[1];
          const x0=api.coord([a,idx])[0];
          const x1=api.coord([b,idx])[0];
          const h=api.size([0,1])[1]*0.6;
          return{type:"rect",shape:{x:x0,y:y-h/2,width:x1-x0,height:h},
            style:{fill:varColor}};
        }
      });
    });
    idx++;
  });

  chart.setOption({
    backgroundColor:"#020617",
    grid,
    xAxis:[{type:"time",min,max,axisLabel:{color:"#e5e7eb"},splitLine:{lineStyle:{color:"#1e293b"}}}],
    yAxis,
    series,
    axisPointer:{link:[{xAxisIndex:"all"}]},
    dataZoom:[
      {type:"inside",xAxisIndex:0},
      {type:"slider",xAxisIndex:0,bottom:5}
    ]
  },true);
}

/* ========= START ========= */
const varColor="#22c55e";
load();
</script>

</body>
</html>
