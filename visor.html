<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visor Sensores (S) + Drivers (D)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>

  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 16px; }
    h1 { margin: 0 0 6px; }
    .sub { color:#444; margin: 0 0 14px; }

    .topbar{
      border:1px solid #ddd; border-radius:12px; padding:12px;
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
      margin-bottom:12px;
    }

    .box{
      border:1px solid #ddd; border-radius:12px; padding:12px;
      margin-bottom:12px;
    }

    .cols { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .cols { grid-template-columns: 1fr; } }

    .list{
      max-height: 260px;
      overflow:auto;
      border:1px solid #eee;
      border-radius:10px;
      padding:10px;
      background:#fafafa;
    }

    .list label{ display:flex; gap:8px; align-items:center; margin:4px 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { padding:7px 10px; cursor:pointer; }
    select { padding:6px 10px; }
    .pill{ padding:3px 8px; border-radius:999px; background:#eee; font-size:12px; }
    .warn{ background:#fff2cc; }
    .ok{ background:#d9ead3; }

    #wrapChart{
      border:1px solid #ddd; border-radius:12px; padding:12px;
    }
    canvas{ width:100% !important; height:520px !important; }
  </style>
</head>

<body>
  <h1>Visor S (Temperaturas) + D (Bombas / Equipos)</h1>
  <p class="sub">Elige qué series quieres ver. S va en °C (eje izquierdo) y D en 0/1 (eje derecho). Zoom con rueda y pan arrastrando.</p>

  <div class="topbar">
    <div class="row">
      <label><b>Rango:</b></label>
      <select id="range">
        <option value="24">Últimas 24h</option>
        <option value="48">Últimas 48h</option>
        <option value="168">Últimos 7 días</option>
        <option value="all">Todo</option>
      </select>
      <button id="btnReload">Recargar</button>
      <button id="btnReset">Reset zoom</button>
      <span id="info" class="pill warn">Sin cargar</span>
    </div>
  </div>

  <div class="cols">
    <div class="box">
      <div class="row" style="justify-content:space-between;">
        <b>Temperaturas (S)</b>
        <div class="row">
          <button id="sAll">Mostrar todas</button>
          <button id="sNone">Ocultar todas</button>
        </div>
      </div>
      <div id="sList" class="list"></div>
    </div>

    <div class="box">
      <div class="row" style="justify-content:space-between;">
        <b>Bombas / Equipos (D)</b>
        <div class="row">
          <button id="dAll">Mostrar todas</button>
          <button id="dNone">Ocultar todas</button>
        </div>
      </div>
      <div id="dList" class="list"></div>
      <p style="margin:8px 0 0; color:#555; font-size:13px;">
        Nota: los drivers se muestran como 0/1 (OFF/ON). Si activas muchos a la vez, se separan con un “offset” pequeño para que no se pisen.
      </p>
    </div>
  </div>

  <div id="wrapChart">
    <canvas id="chart"></canvas>
  </div>

<script>
/** ========= CONFIG: ajusta a tus ficheros reales ========= **/

// Sensores S: usa los que tengas como txt. Ej: data/acs_S9.txt o data/sensor_S9.txt.
// En tu caso ya estás guardando ACS como "acs_S9.txt" (según lo que venías haciendo).
const SENSORS = [
  // id, nombre visible, fichero txt (relativo a /sensores/)
  { id:"S1",  name:"S1 · Tª Exterior",              file:"data/acs_S1.txt"  },
  { id:"S2",  name:"S2 · Tª Imp. Cald. 1 ACS",      file:"data/acs_S2.txt"  },
  { id:"S3",  name:"S3 · Tª Imp. Cald. 2 Calef.",   file:"data/acs_S3.txt"  },
  { id:"S4",  name:"S4 · Tª Ret. Cald. 1 ACS",      file:"data/acs_S4.txt"  },
  { id:"S5",  name:"S5 · Tª Ret. Cald. 2 Calef.",   file:"data/acs_S5.txt"  },
  { id:"S7",  name:"S7 · Tª Ida Calefacción",       file:"data/acs_S7.txt"  },
  { id:"S8",  name:"S8 · Tª Ida Primario ACS",      file:"data/acs_S8.txt"  },
  { id:"S9",  name:"S9 · Tª Depósito ACS",          file:"data/acs_S9.txt"  },
  { id:"S10", name:"S10 · Tª Consumo ACS",          file:"data/acs_S10.txt" },
  { id:"S13", name:"S13 · Tª Retorno ACS",          file:"data/acs_S13.txt" },
  { id:"S15", name:"S15 · Tª Retorno Primario ACS", file:"data/acs_S15.txt" }
];

// Drivers D: ejemplo D1..D30, ajusta nombres y ficheros si quieres.
const DRIVERS = [
  { id:"D1",  name:"D1 · M-P B. 5.2 (Primario caldera 2)", file:"data/drv_D1.txt" },
  { id:"D2",  name:"D2 · M-P B. 5.1",                      file:"data/drv_D2.txt" },
  { id:"D3",  name:"D3 · ON-OFF B.1 Caldera ACS",          file:"data/drv_D3.txt" },
  { id:"D4",  name:"D4 · M-P B.2 Caldera Calefacción",     file:"data/drv_D4.txt" },
  { id:"D5",  name:"D5 · ON-OFF B.3A.1 Prim. ACS",         file:"data/drv_D5.txt" },
  { id:"D6",  name:"D6 · ON-OFF B.3A.2 Prim. ACS",         file:"data/drv_D6.txt" },
  { id:"D7",  name:"D7 · M-P B.3B.1 Sec. ACS",             file:"data/drv_D7.txt" },
  { id:"D8",  name:"D8 · M-P B.3B.2 Sec. ACS",             file:"data/drv_D8.txt" },
  { id:"D9",  name:"D9 · M-P B.7.1 Paneles",               file:"data/drv_D9.txt" },
  { id:"D10", name:"D10 · M-P B.7.2 Paneles",              file:"data/drv_D10.txt" },
  { id:"D12", name:"D12 · A-C V2V Caldera 2",              file:"data/drv_D12.txt" },
  { id:"D13", name:"D13 · M-P Quemador Caldera 2",         file:"data/drv_D13.txt" },
  { id:"D15", name:"D15 · A-C V2V Caldera 1",              file:"data/drv_D15.txt" },
  { id:"D16", name:"D16 · M-P Quemador Caldera 1",         file:"data/drv_D16.txt" },
  { id:"D17", name:"D17 · M-P B.6 Sec. Paneles",           file:"data/drv_D17.txt" },
  { id:"D19", name:"D19 · V3V Aerotermo",                  file:"data/drv_D19.txt" },
  { id:"D20", name:"D20 · V3V Consumo ACS",                file:"data/drv_D20.txt" },
  { id:"D21", name:"D21 · V3V Piscina",                    file:"data/drv_D21.txt" },
  { id:"D22", name:"D22 · V3V Intercambiador Solar",       file:"data/drv_D22.txt" },
  { id:"D24", name:"D24 · M-P B.4 Retorno ACS",            file:"data/drv_D24.txt" },
  { id:"D27", name:"D27 · Regulación Quemador",            file:"data/drv_D27.txt" },
  { id:"D28", name:"D28 · On-Off B.8.1 Piscina",           file:"data/drv_D28.txt" },
  { id:"D29", name:"D29 · On-Off B.8.2 Piscina",           file:"data/drv_D29.txt" },
  { id:"D30", name:"D30 · On-Off Aerotermo",               file:"data/drv_D30.txt" }
];

/** ========= FIN CONFIG ========= **/

const sList = document.getElementById("sList");
const dList = document.getElementById("dList");
const info = document.getElementById("info");
const btnReload = document.getElementById("btnReload");
const btnReset = document.getElementById("btnReset");
const rangeSel = document.getElementById("range");

function addCheckbox(container, item, group) {
  const id = `${group}_${item.id}`;
  const label = document.createElement("label");
  label.innerHTML = `<input type="checkbox" id="${id}" data-id="${item.id}"> <span>${item.name}</span>`;
  container.appendChild(label);
}

SENSORS.forEach(s => addCheckbox(sList, s, "S"));
DRIVERS.forEach(d => addCheckbox(dList, d, "D"));

// Por defecto marca algunos típicos
document.getElementById("S_S9")?.click?.();
document.getElementById("S_S10")?.click?.();
document.getElementById("D_D1")?.click?.();

function parseTemp(v) {
  const s = String(v||"").trim();
  if (!s || s === "NOT_FOUND") return null;
  const n = Number(s.replace(",", "."));
  return Number.isFinite(n) ? n : null;
}

function parseOnOff(v) {
  const s = String(v||"").trim().toLowerCase();
  if (s === "on") return 1;
  if (s === "off") return 0;
  return null;
}

async function loadTxtPoints(file, kind) {
  const res = await fetch(`${file}?ts=${Date.now()}`);
  if (!res.ok) throw new Error(`No se pudo leer ${file} (${res.status})`);
  const txt = await res.text();
  const points = [];
  const lines = txt.split(/\r?\n/).filter(Boolean);

  for (const line of lines) {
    const [ts, val] = line.split(";");
    if (!ts) continue;

    let y = null;
    if (kind === "S") y = parseTemp(val);
    if (kind === "D") y = parseOnOff(val);

    if (y === null) continue;
    points.push({ x: new Date(ts), y });
  }
  return points;
}

function applyRange(points, rangeVal) {
  if (rangeVal === "all") return points;
  const hours = Number(rangeVal);
  const cutoff = Date.now() - hours * 3600 * 1000;
  return points.filter(p => p.x.getTime() >= cutoff);
}

function selectedIds(prefix) {
  return [...document.querySelectorAll(`input[id^="${prefix}_"]:checked`)].map(cb => cb.dataset.id);
}

function setAll(prefix, checked) {
  document.querySelectorAll(`input[id^="${prefix}_"]`).forEach(cb => cb.checked = checked);
}

document.getElementById("sAll").onclick = () => setAll("S", true);
document.getElementById("sNone").onclick = () => setAll("S", false);
document.getElementById("dAll").onclick = () => setAll("D", true);
document.getElementById("dNone").onclick = () => setAll("D", false);

const chart = new Chart(document.getElementById("chart"), {
  type: "line",
  data: { datasets: [] },
  options: {
    parsing: false,
    maintainAspectRatio: false,
    scales: {
      x: { type: "time", title: { display: true, text: "Fecha y hora" } },
      yTemp: {
        type: "linear",
        position: "left",
        title: { display: true, text: "Temperatura (°C)" }
      },
      yState: {
        type: "linear",
        position: "right",
        min: -0.1,
        max: 1.1,
        grid: { drawOnChartArea: false },
        ticks: {
          stepSize: 1,
          callback: (v) => (v === 1 ? "ON" : (v === 0 ? "OFF" : v))
        },
        title: { display: true, text: "Estado (0/1)" }
      }
    },
    plugins: {
      legend: { display: true },
      zoom: {
        pan: { enabled: true, mode: "x" },
        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: "x" }
      },
      tooltip: {
        callbacks: {
          label: (ctx) => {
            const ds = ctx.dataset;
            if (ds.yAxisID === "yState") return `${ds.label}: ${ctx.raw.y === 1 ? "ON" : "OFF"}`;
            return `${ds.label}: ${ctx.raw.y}`;
          }
        }
      }
    }
  }
});

function makeDataset(label, points, kind, offsetIndex = 0) {
  if (kind === "S") {
    return {
      label,
      data: points,
      yAxisID: "yTemp",
      borderWidth: 2,
      pointRadius: 0
    };
  }
  // Drivers: stepped, con offset para separarlas un poco
  const offset = offsetIndex * 0.06; // 0.06, 0.12... (visual)
  const shifted = points.map(p => ({ x: p.x, y: p.y + offset }));
  return {
    label: `${label} (0/1)`,
    data: shifted,
    yAxisID: "yState",
    stepped: true,
    borderWidth: 2,
    pointRadius: 0
  };
}

async function refresh() {
  const rangeVal = rangeSel.value;
  const sIds = selectedIds("S");
  const dIds = selectedIds("D");

  if (sIds.length === 0 && dIds.length === 0) {
    chart.data.datasets = [];
    chart.update();
    info.textContent = "Selecciona al menos 1 serie";
    info.className = "pill warn";
    return;
  }

  info.textContent = "Cargando…";
  info.className = "pill warn";

  const datasets = [];

  // Carga S
  for (const sid of sIds) {
    const s = SENSORS.find(x => x.id === sid);
    if (!s) continue;
    try {
      let pts = await loadTxtPoints(s.file, "S");
      pts = applyRange(pts, rangeVal);
      datasets.push(makeDataset(s.name, pts, "S"));
    } catch (e) {
      // si falta el txt, lo ignoramos (no rompe)
      console.warn(e);
    }
  }

  // Carga D con offset
  let idx = 0;
  for (const did of dIds) {
    const d = DRIVERS.find(x => x.id === did);
    if (!d) continue;
    try {
      let pts = await loadTxtPoints(d.file, "D");
      pts = applyRange(pts, rangeVal);
      datasets.push(makeDataset(d.name, pts, "D", idx));
      idx++;
    } catch (e) {
      console.warn(e);
    }
  }

  chart.data.datasets = datasets;
  chart.update();

  info.textContent = `Mostrando: ${sIds.length} S + ${dIds.length} D · ${new Date().toISOString()}`;
  info.className = "pill ok";
}

btnReload.onclick = () => refresh().catch(e => alert(e.message));
btnReset.onclick = () => chart.resetZoom();
rangeSel.onchange = () => refresh().catch(e => alert(e.message));

// Auto-refresco si marcas/desmarcas
document.addEventListener("change", (ev) => {
  if (ev.target && ev.target.matches('input[type="checkbox"]')) {
    refresh().catch(e => console.warn(e));
  }
});

refresh().catch(e => alert(e.message));
</script>
</body>
</html>
