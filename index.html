<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BMS ¬∑ Index</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070A12; --bg1:#0B1020; --txt:#EAF0FF;
      --muted: rgba(234,240,255,.68); --muted2: rgba(234,240,255,.45);
      --stroke: rgba(255,255,255,.10); --stroke2: rgba(255,255,255,.16);
      --shadow: 0 18px 45px rgba(0,0,0,.45); --r:18px;
      --ok:#35D07F; --bad:#FF5C5C; --accent:#7C5CFF; --accent2:#3BE7FF;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(124,92,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 10%, rgba(59,231,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .wrap{max-width:1280px;margin:0 auto;padding:22px 16px 60px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius:calc(var(--r)+4px); box-shadow:var(--shadow); backdrop-filter: blur(10px);
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:
        radial-gradient(10px 10px at 30% 35%, rgba(255,255,255,.8), transparent 55%),
        linear-gradient(135deg, rgba(124,92,255,1), rgba(59,231,255,1));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 28px rgba(124,92,255,.25);
    }
    .brand h1{margin:0;font-size:14px;line-height:1.1;font-weight:900}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px;font-weight:800}
    .nav{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--stroke2); background:rgba(255,255,255,.06);
      color:var(--txt); text-decoration:none; font-weight:900; font-size:13px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(180deg,var(--accent),var(--accent2));box-shadow:0 0 0 4px rgba(124,92,255,.14)}
    .status{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px; border-radius:999px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      color:var(--muted); font-size:12px; font-weight:900;
    }
    .led{width:8px;height:8px;border-radius:999px;background:var(--bad);box-shadow:0 0 0 4px rgba(255,92,92,.12)}
    .led.ok{background:var(--ok);box-shadow:0 0 0 4px rgba(53,208,127,.12)}

    .grid{margin-top:16px;display:grid;grid-template-columns:1.25fr .75fr;gap:16px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius:var(--r); box-shadow:var(--shadow); backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .head{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;gap:10px;align-items:center}
    .head h2{margin:0;font-size:14px;font-weight:900}
    .head .hint{font-size:12px;color:var(--muted);font-weight:900}
    .body{padding:14px 16px}

    .section{margin-top:14px;color:var(--muted);font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:.2px;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .tag{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      flex:1 1 280px; min-width:280px;
    }
    .chip{
      width:36px;height:36px;border-radius:12px;
      background:
        radial-gradient(10px 10px at 30% 35%, rgba(255,255,255,.7), transparent 55%),
        linear-gradient(135deg, rgba(124,92,255,.95), rgba(59,231,255,.85));
      border:1px solid rgba(255,255,255,.14);
      flex:0 0 auto;
    }
    .k{min-width:0}
    .name{font-weight:900;font-size:13px}
    .desc{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px}
    .vals{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .vb{padding:7px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.20);min-width:86px;text-align:right}
    .lab{font-size:10px;color:var(--muted2);font-weight:900;text-transform:uppercase;letter-spacing:.6px}
    .num{font-size:13px;font-weight:900;margin-top:2px}

    .mini{width:100%;border-collapse:separate;border-spacing:0 8px}
    .mini td{padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10)}
    .mini td:first-child{border-radius:14px 0 0 14px;font-weight:900}
    .mini td:last-child{border-radius:0 14px 14px 0;text-align:right;color:var(--muted);font-weight:900}

    .note{margin-top:10px;color:var(--muted2);font-size:12px;font-weight:700}
    .svgWrap{height:340px;padding:10px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18)}
    .svgWrap svg{width:100%;height:100%}
    .axisText{fill:rgba(234,240,255,.55);font-size:11px;font-weight:800}
    .gridLine{stroke:rgba(255,255,255,.08);stroke-width:1}
    .line{fill:none;stroke:rgba(59,231,255,.95);stroke-width:2}
    .area{fill:rgba(59,231,255,.12)}
    .pt{fill:rgba(234,240,255,.9)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>BMS ¬∑ Sala de Calderas</h1>
          <div class="sub">Index ¬∑ √öltimos valores desde latest_all.json / latest.json</div>
        </div>
      </div>

      <div class="nav">
        <a class="btn" href="esquema.html"><span class="dot"></span> Esquema</a>
        <a class="btn" href="visor.html"><span class="dot"></span> Visor</a>
      </div>

      <div class="status">
        <span id="led" class="led"></span>
        <span id="statusText">cargando‚Ä¶</span>
        <span style="opacity:.6">¬∑</span>
        <span id="lastUpdate">‚Äî</span>
      </div>
    </div>

    <div class="grid">
      <!-- IZQ -->
      <div class="card">
        <div class="head">
          <h2>üìà S9 (puntos reales)</h2>
          <div class="hint">S9.txt</div>
        </div>
        <div class="body">
          <div class="svgWrap">
            <svg id="s9svg" viewBox="0 0 1000 340" preserveAspectRatio="none"></svg>
          </div>

          <div class="section"><span>Drivers</span><span id="driversCount" class="hint">‚Äî</span></div>
          <div class="tags" id="driversTags"></div>

          <div class="section"><span>Sondas</span><span id="sensorsCount" class="hint">‚Äî</span></div>
          <div class="tags" id="sensorsTags"></div>

          <div class="note">
            ‚úÖ √öltimos valores: <b>latest_all.json</b> (preferido) o <b>latest.json</b> (fallback).<br>
            ‚úÖ Nombres: <b>drivers_manifest.json</b> y <b>sensors_manifest.json</b>.<br>
            ‚úÖ Media/m√°x/m√≠n: desde cada <b>.txt</b>.
          </div>
        </div>
      </div>

      <!-- DCHA -->
      <div class="card">
        <div class="head">
          <h2>üßæ Diagn√≥stico</h2>
          <div class="hint">qu√© est√° cargando</div>
        </div>
        <div class="body">
          <table class="mini" id="mini">
            <tr><td>Estado</td><td>‚Äî</td></tr>
          </table>
          <div class="note">Si algo falla, el ‚ÄúDiagn√≥stico‚Äù te dir√° exactamente qu√© fichero no se pudo leer.</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ============================
  // Config m√≠nima
  // ============================
  const REFRESH_MS = 60_000;
  const SENSOR_TXT = (id) => `${id}.txt`;
  const DRIVER_TXT = (id) => `drv_${id}.txt`;
  const MAX_POINTS_S9 = 400;
  const FETCH_CONCURRENCY = 6;

  // ============================
  // Helpers
  // ============================
  const $ = (id) => document.getElementById(id);
  const safeObj = (x) => (x && typeof x === "object") ? x : {};
  const fmt = (n) => (Number.isFinite(n) ? (Math.round(n*100)/100).toFixed(2) : "‚Äî");

  function setStatus(ok, text){
    $("led").classList.toggle("ok", !!ok);
    $("statusText").textContent = text;
  }

  async function fetchJson(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`No puedo leer ${url} (HTTP ${r.status})`);
    return r.json();
  }
  async function fetchText(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`No puedo leer ${url} (HTTP ${r.status})`);
    return r.text();
  }

  function normalizeManifest(raw){
    const o = safeObj(raw);
    let arr = [];
    if (Array.isArray(o)) arr = o;
    else if (Array.isArray(o.items)) arr = o.items;
    else if (Array.isArray(o.sensors)) arr = o.sensors;
    else if (Array.isArray(o.drivers)) arr = o.drivers;
    else {
      for (const [id, v] of Object.entries(o)){
        if (v && typeof v === "object") arr.push({ id, ...v });
      }
    }
    return arr
      .map(it => ({
        id: (it.id || it.code || it.key || "").toString().trim(),
        name: (it.name || it.title || it.label || "").toString().trim()
      }))
      .filter(it => it.id);
  }

  // TXT: saca valores (√∫ltimo n√∫mero por l√≠nea)
  function parseValuesFromTxt(txt){
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const values = [];
    const tss = [];
    for (const line of lines){
      const m = line.match(/(-?\d+(?:[.,]\d+)?)(?!.*-?\d)/);
      if(!m) continue;
      const v = Number(m[1].replace(",", "."));
      if(!Number.isFinite(v)) continue;
      const left = line.slice(0, m.index).trim().replace(/[;,]$/, "").trim();
      tss.push(left);
      values.push(v);
    }
    return { tss, values };
  }

  function statsFromValues(values){
    const arr = values.filter(Number.isFinite);
    if(!arr.length) return { last: NaN, avg: NaN, min: NaN, max: NaN };
    const min = Math.min(...arr);
    const max = Math.max(...arr);
    const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
    const last = arr[arr.length-1];
    return { last, avg, min, max };
  }

  function addTag(container, title, lastValue, stats){
    const el = document.createElement("div");
    el.className = "tag";
    el.innerHTML = `
      <div class="chip"></div>
      <div class="k">
        <div class="name">${title}</div>
        <div class="desc">√öltimo (JSON) + Media/M√°x/M√≠n (TXT)</div>
      </div>
      <div class="vals">
        <div class="vb"><div class="lab">√ölt</div><div class="num">${fmt(lastValue)}</div></div>
        <div class="vb"><div class="lab">Media</div><div class="num">${fmt(stats.avg)}</div></div>
        <div class="vb"><div class="lab">M√°x</div><div class="num">${fmt(stats.max)}</div></div>
        <div class="vb"><div class="lab">M√≠n</div><div class="num">${fmt(stats.min)}</div></div>
      </div>
    `;
    container.appendChild(el);
  }

  // Concurrencia limitada (para que no se "cuelgue")
  async function mapLimit(items, limit, fn){
    const out = new Array(items.length);
    let i = 0;
    const workers = Array.from({length: limit}, async () => {
      while(true){
        const idx = i++;
        if(idx >= items.length) break;
        out[idx] = await fn(items[idx], idx);
      }
    });
    await Promise.all(workers);
    return out;
  }

  // ============================
  // Latest JSON (prefer latest_all)
  // ============================
  async function loadLatest(){
    try { return await fetchJson("latest_all.json"); }
    catch { return await fetchJson("latest.json"); }
  }

  function getLastFromLatest(latest, id){
    // Soporta varias formas:
    // 1) latest[id] = number
    // 2) latest.sensors[id] / latest.drivers[id]
    // 3) latest.sensors[id].value / latest.drivers[id].value
    const L = safeObj(latest);

    const tryPaths = [
      () => L[id],
      () => L.sensors && L.sensors[id],
      () => L.drivers && L.drivers[id],
      () => L.S && L.S[id],
      () => L.D && L.D[id],
    ];

    let v;
    for (const f of tryPaths){
      const x = f();
      if (x == null) continue;
      v = (x && typeof x === "object") ? (x.value ?? x.v ?? x.last ?? x.val) : x;
      if (v != null) break;
    }
    const n = Number(String(v).replace(",", "."));
    return Number.isFinite(n) ? n : NaN;
  }

  function setLastUpdate(latest){
    const ts = latest.ts || latest.timestamp || latest.updated_at || latest.last_update || "";
    const d = new Date(ts);
    $("lastUpdate").textContent = (!ts || isNaN(d.getTime())) ? "‚Äî" : d.toLocaleString("es-ES");
  }

  // ============================
  // SVG chart S9 (simple)
  // ============================
  function drawS9(values){
    const svg = $("s9svg");
    svg.innerHTML = "";

    const W = 1000, H = 340;
    const padL = 40, padR = 10, padT = 12, padB = 22;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    const v = values.slice(-MAX_POINTS_S9);
    if (v.length < 2){
      svg.innerHTML = `<text x="40" y="40" class="axisText">Sin datos suficientes en S9.txt</text>`;
      return;
    }

    const min = Math.min(...v), max = Math.max(...v);
    const span = (max - min) || 1;

    for(let k=0;k<=4;k++){
      const y = padT + (plotH * k/4);
      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1", padL); line.setAttribute("x2", W-padR);
      line.setAttribute("y1", y); line.setAttribute("y2", y);
      line.setAttribute("class","gridLine");
      svg.appendChild(line);

      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x", 6);
      t.setAttribute("y", y+4);
      t.setAttribute("class","axisText");
      t.textContent = fmt(max - span*(k/4));
      svg.appendChild(t);
    }

    const pts = v.map((val,i)=>{
      const x = padL + (plotW * (i/(v.length-1)));
      const y = padT + (plotH * (1 - ((val - min)/span)));
      return [x,y];
    });

    const d = pts.map((p,i)=> (i===0?`M ${p[0]} ${p[1]}`:`L ${p[0]} ${p[1]}`)).join(" ");
    const areaD = `M ${pts[0][0]} ${H-padB} ` + pts.map(p=>`L ${p[0]} ${p[1]}`).join(" ") + ` L ${pts[pts.length-1][0]} ${H-padB} Z`;

    const area = document.createElementNS("http://www.w3.org/2000/svg","path");
    area.setAttribute("d", areaD);
    area.setAttribute("class","area");
    svg.appendChild(area);

    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d", d);
    path.setAttribute("class","line");
    svg.appendChild(path);

    const last = pts[pts.length-1];
    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx", last[0]); c.setAttribute("cy", last[1]); c.setAttribute("r", 3.2);
    c.setAttribute("class","pt");
    svg.appendChild(c);
  }

  // ============================
  // Main
  // ============================
  async function cycle(){
    const mini = $("mini");
    const driversTags = $("driversTags");
    const sensorsTags = $("sensorsTags");

    driversTags.innerHTML = "";
    sensorsTags.innerHTML = "";
    mini.innerHTML = `<tr><td>Estado</td><td>cargando‚Ä¶</td></tr>`;
    setStatus(false, "cargando‚Ä¶");

    try{
      // 1) Manifests (nombres)
      const [sensManRaw, drvManRaw] = await Promise.all([
        fetchJson("sensors_manifest.json"),
        fetchJson("drivers_manifest.json")
      ]);
      const sensors = normalizeManifest(sensManRaw);
      const drivers = normalizeManifest(drvManRaw);

      $("sensorsCount").textContent = sensors.length.toString();
      $("driversCount").textContent = drivers.length.toString();

      // 2) Latest (√∫ltimos valores)
      const latest = await loadLatest();
      setLastUpdate(latest);

      // 3) S9 chart (puntos reales)
      const s9txt = await fetchText("S9.txt");
      const s9vals = parseValuesFromTxt(s9txt).values;
      drawS9(s9vals);

      // 4) Tags: last desde JSON + stats desde TXT
      // Sondas
      const sensorsSorted = sensors.slice().sort((a,b)=>a.id.localeCompare(b.id,"es",{numeric:true}));
      await mapLimit(sensorsSorted, FETCH_CONCURRENCY, async (s) => {
        const txt = await fetchText(SENSOR_TXT(s.id));
        const { values } = parseValuesFromTxt(txt);
        const st = statsFromValues(values);
        const last = getLastFromLatest(latest, s.id);
        addTag(sensorsTags, `${s.name || s.id} (${s.id})`, last, st);
      });

      // Drivers
      const driversSorted = drivers.slice().sort((a,b)=>a.id.localeCompare(b.id,"es",{numeric:true}));
      await mapLimit(driversSorted, FETCH_CONCURRENCY, async (d) => {
        const txt = await fetchText(DRIVER_TXT(d.id));
        const { values } = parseValuesFromTxt(txt);
        const st = statsFromValues(values);
        const last = getLastFromLatest(latest, d.id);
        addTag(driversTags, `${d.name || d.id} (${d.id})`, last, st);
      });

      // 5) Diagn√≥stico OK
      mini.innerHTML = `
        <tr><td>latest usado</td><td>${latest && (latest.ts || latest.timestamp || latest.updated_at || latest.last_update) ? "OK" : "OK (sin ts)"}</td></tr>
        <tr><td>S9.txt</td><td>${s9vals.length} puntos</td></tr>
        <tr><td>Sondas</td><td>${sensors.length}</td></tr>
        <tr><td>Drivers</td><td>${drivers.length}</td></tr>
      `;

      setStatus(true, "online");
    }catch(e){
      console.error(e);
      mini.innerHTML = `<tr><td>Error</td><td>${String(e.message || e)}</td></tr>`;
      setStatus(false, "error");
    }
  }

  cycle();
  setInterval(cycle, REFRESH_MS);
</script>
</body>
</html>
