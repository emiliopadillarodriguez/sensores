<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BMS Dashboard Â· Index</title>

  <!-- TipografÃ­a -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --txt:#EAF0FF;
      --muted: rgba(234,240,255,.68);
      --muted2: rgba(234,240,255,.45);
      --ok:#35D07F;
      --warn:#F7C948;
      --bad:#FF5C5C;
      --accent:#7C5CFF;
      --accent2:#3BE7FF;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(124,92,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 10%, rgba(59,231,255,.18), transparent 60%),
        radial-gradient(700px 700px at 55% 90%, rgba(53,208,127,.10), transparent 62%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{max-width:1280px;margin:0 auto;padding:26px 18px 70px}

    .topbar{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:14px 16px;border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:260px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:
        radial-gradient(10px 10px at 30% 35%, rgba(255,255,255,.8), transparent 55%),
        linear-gradient(135deg, rgba(124,92,255,1), rgba(59,231,255,1));
      box-shadow:0 10px 25px rgba(124,92,255,.25);
      border:1px solid rgba(255,255,255,.16);
    }
    .brand h1{font-size:14px;line-height:1.1;margin:0;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .btn{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;border:1px solid var(--stroke2);
      background:rgba(255,255,255,.06);color:var(--txt);text-decoration:none;
      font-weight:800;font-size:13px;transition:transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.22)}
    .btn .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(180deg, var(--accent), var(--accent2));box-shadow:0 0 0 4px rgba(124,92,255,.14)}

    .status{display:flex;align-items:flex-end;gap:14px;min-width:290px;justify-content:flex-end;text-align:right}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      border:1px solid var(--stroke);background:rgba(255,255,255,.05);
      color:var(--muted);font-size:12px;font-weight:800;white-space:nowrap;
    }
    .led{width:8px;height:8px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 4px rgba(247,201,72,.12)}
    .led.ok{background:var(--ok); box-shadow:0 0 0 4px rgba(53,208,127,.12)}
    .led.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,92,92,.12)}
    .meta{display:flex;flex-direction:column;gap:2px}
    .meta .t{font-size:12px;color:var(--muted);font-weight:800}
    .meta .v{font-size:13px;font-weight:900;letter-spacing:.2px}

    .grid{margin-top:16px;display:grid;grid-template-columns:1.4fr .9fr;gap:16px;align-items:start}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .status{min-width:auto}
      .brand{min-width:auto}
    }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card .head{
      padding:14px 16px;display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);gap:10px
    }
    .card .head h2{margin:0;font-size:14px;font-weight:900;letter-spacing:.2px}
    .card .head .hint{color:var(--muted);font-size:12px;font-weight:800;white-space:nowrap}
    .card .body{padding:14px 16px}

    .chartWrap{height:360px;padding:10px 8px 12px}
    canvas{display:block;width:100% !important;height:100% !important}

    .foot{
      margin-top:14px;color:var(--muted2);font-size:12px;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center
    }
    .spark{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.25);box-shadow:0 0 0 4px rgba(255,255,255,.06);display:inline-block;margin-right:8px;vertical-align:-1px}

    .sectionTitle{
      margin:14px 0 8px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.2px;
      font-size:12px;
      text-transform: uppercase;
    }

    .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .tag{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      min-width:240px;flex:1 1 240px;
    }
    .chip{
      width:36px;height:36px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(10px 10px at 30% 35%, rgba(255,255,255,.7), transparent 55%),
        linear-gradient(135deg, rgba(124,92,255,.95), rgba(59,231,255,.85));
      box-shadow:0 10px 25px rgba(59,231,255,.10);
      flex:0 0 auto;
    }
    .tag .k{display:flex;flex-direction:column;gap:2px;min-width:0}
    .tag .k .name{font-weight:900;font-size:13px;letter-spacing:.2px}
    .tag .k .desc{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px}
    .tag .vals{margin-left:auto;display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;justify-content:flex-end}
    .valBox{
      padding:7px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);min-width:86px;text-align:right
    }
    .valBox .lab{font-size:10px;color:var(--muted2);font-weight:900;letter-spacing:.6px;text-transform:uppercase}
    .valBox .num{font-size:13px;font-weight:900;letter-spacing:.2px;margin-top:2px}

    .mini{width:100%;border-collapse:separate;border-spacing:0 8px}
    .mini td{padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10)}
    .mini td:first-child{border-radius:14px 0 0 14px;font-weight:900}
    .mini td:last-child{border-radius:0 14px 14px 0;text-align:right;color:var(--muted);font-weight:800}

    .tinyNote{color:var(--muted2);font-size:11px;font-weight:700}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>BMS Â· Sala de Calderas</h1>
          <div class="sub">Index Â· Resumen comercial (sin inventar datos)</div>
        </div>
      </div>

      <div class="nav">
        <a class="btn" href="esquema.html"><span class="dot"></span> Esquema</a>
        <a class="btn" href="visor.html"><span class="dot"></span> Visor</a>
      </div>

      <div class="status">
        <span class="pill"><span id="led" class="led"></span><span id="connText">cargandoâ€¦</span></span>
        <div class="meta">
          <div class="t">Ãšltima actualizaciÃ³n</div>
          <div class="v" id="lastUpdate">â€”</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- IZQ -->
      <div class="card">
        <div class="head">
          <h2>ðŸ“ˆ Tendencia real Â· S9</h2>
          <div class="hint">puntos leÃ­dos de <b>S9.txt</b></div>
        </div>
        <div class="body">
          <div class="chartWrap">
            <canvas id="chartS9"></canvas>
          </div>

          <div class="foot">
            <div><span class="spark"></span>Etiquetas con Ãºltimo / media / mÃ¡x / mÃ­n calculado desde los <b>.txt</b>.</div>
            <div class="tinyNote">
              Nombres desde <b>sensors_manifest.json</b> y <b>drivers_manifest.json</b>.
              Ãšltimas lecturas desde <b>latest_all.json</b> / <b>latest.json</b> / <b>drivers_latest.json</b>.
            </div>
          </div>

          <div class="sectionTitle">Drivers</div>
          <div class="tags" id="tagsDrivers"></div>

          <div class="sectionTitle">Sondas</div>
          <div class="tags" id="tagsSensors"></div>
        </div>
      </div>

      <!-- DCHA -->
      <div class="card">
        <div class="head">
          <h2>ðŸ§¾ Resumen rÃ¡pido</h2>
          <div class="hint">KPIs</div>
        </div>
        <div class="body">
          <table class="mini" id="miniTable">
            <tr><td>Cargandoâ€¦</td><td>â€”</td></tr>
          </table>
          <div class="foot">
            <div>Auto-refresh: <b>60 s</b></div>
            <div id="pathsNote" class="tinyNote">Leyendo ficheros en la misma ruta del index.html</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // =========================
    // Config
    // =========================
    const REFRESH_MS = 60_000;

    // TXT por defecto (si el manifest no trae el nombre del fichero)
    const SENSOR_TXT = (id) => `${id}.txt`;          // p.ej. S9 -> S9.txt
    const DRIVER_TXT = (id) => `drv_${id}.txt`;      // p.ej. D1 -> drv_D1.txt

    // =========================
    // Helpers
    // =========================
    const safeObj = (x) => (x && typeof x === "object") ? x : {};
    const fmt = (n) => (Number.isFinite(n) ? (Math.round(n * 100) / 100).toFixed(2) : "â€”");

    function setConnection(ok, text){
      const led = document.getElementById("led");
      const connText = document.getElementById("connText");
      led.classList.remove("ok","bad");
      led.classList.add(ok ? "ok" : "bad");
      connText.textContent = text;
    }

    async function fetchText(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${url}`);
      return await res.text();
    }
    async function fetchJson(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${url}`);
      return await res.json();
    }

    // Parser robusto para lÃ­neas tipo:
    // - "2026-01-12T10:00:00+01:00,52.3"
    // - "2026-01-12 10:00:00; 52.3"
    // - "timestamp value"
    // - "52.3"
    function parseSeriesFromTxt(txt){
      const lines = txt.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

      const series = [];
      for (const line of lines){
        // extrae el Ãºltimo nÃºmero "real" de la lÃ­nea
        const m = line.match(/(-?\d+(?:[.,]\d+)?)(?!.*-?\d)/);
        if (!m) continue;

        const rawNum = m[1].replace(",", ".");
        const v = Number(rawNum);
        if (!Number.isFinite(v)) continue;

        // timestamp: lo que haya antes del nÃºmero
        const left = line.slice(0, m.index).trim().replace(/[;,]$/, "").trim();
        const ts = left || ""; // si no hay fecha, dejamos vacÃ­o

        series.push({ ts, v });
      }
      return series;
    }

    function computeStats(values){
      const arr = values.filter(v => Number.isFinite(v));
      if (!arr.length) return { last: NaN, avg: NaN, min: NaN, max: NaN };
      const min = Math.min(...arr);
      const max = Math.max(...arr);
      const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
      const last = arr[arr.length - 1];
      return { last, avg, min, max };
    }

    function labelFromTs(ts, idx){
      // Si ts se puede convertir a Date, lo formateamos. Si no, mostramos algo corto.
      const d = new Date(ts);
      if (!ts || isNaN(d.getTime())) return `${idx+1}`;
      return d.toLocaleString("es-ES", { hour:"2-digit", minute:"2-digit", day:"2-digit", month:"2-digit" });
    }

    function buildTag(container, name, stats, unit=""){
      const el = document.createElement("div");
      el.className = "tag";
      el.innerHTML = `
        <div class="chip"></div>
        <div class="k">
          <div class="name">${name}</div>
          <div class="desc">Ãšltimo / Media / MÃ¡x / MÃ­n</div>
        </div>
        <div class="vals">
          <div class="valBox"><div class="lab">Ãšlt</div><div class="num">${fmt(stats.last)}${unit}</div></div>
          <div class="valBox"><div class="lab">Media</div><div class="num">${fmt(stats.avg)}${unit}</div></div>
          <div class="valBox"><div class="lab">MÃ¡x</div><div class="num">${fmt(stats.max)}${unit}</div></div>
          <div class="valBox"><div class="lab">MÃ­n</div><div class="num">${fmt(stats.min)}${unit}</div></div>
        </div>
      `;
      container.appendChild(el);
    }

    // =========================
    // Chart S9
    // =========================
    let chart;
    function initChart(){
      const ctx = document.getElementById("chartS9");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "S9",
            data: [],
            tension: 0.25,
            borderWidth: 2,
            pointRadius: 1.5,
            pointHoverRadius: 4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (c) => ` S9: ${fmt(c.parsed.y)}`
              }
            }
          },
          scales: {
            x: {
              ticks: { maxTicksLimit: 10, color: "rgba(234,240,255,.55)" },
              grid: { color: "rgba(255,255,255,.06)" }
            },
            y: {
              ticks: { color: "rgba(234,240,255,.55)" },
              grid: { color: "rgba(255,255,255,.06)" }
            }
          }
        }
      });
    }

    function updateChartFromSeries(series){
      const labels = series.map((p,i) => labelFromTs(p.ts, i));
      const values = series.map(p => Number(p.v));
      chart.data.labels = labels;
      chart.data.datasets[0].data = values;
      chart.update();
    }

    // =========================
    // Lectura de manifests + latest
    // =========================
    function normalizeManifest(obj, kind){
      // Acepta varias formas tÃ­picas:
      // - array: [{id:"S9", name:"ImpulsiÃ³n", file:"S9.txt"}, ...]
      // - objeto: {"S9":{"name":"...","file":"S9.txt"}, ...}
      // - objeto con claves: {items:[...]} o {sensors:[...]} / {drivers:[...]}
      const o = safeObj(obj);

      let items = [];
      if (Array.isArray(o)) items = o;
      else if (Array.isArray(o.items)) items = o.items;
      else if (Array.isArray(o[kind])) items = o[kind];
      else {
        // objeto mapa
        for (const [id, v] of Object.entries(o)){
          if (!v || typeof v !== "object") continue;
          items.push({ id, ...v });
        }
      }

      // normaliza campos
      return items
        .filter(it => it && (it.id || it.code || it.key))
        .map(it => {
          const id = it.id || it.code || it.key;
          const name = it.name || it.title || id;
          const file = it.file || it.txt || it.path || "";
          return { id, name, file };
        });
    }

    function pickLastUpdate(latestAny){
      // Intenta sacar fecha desde varios JSON habituales
      const cands = [
        latestAny?.ts, latestAny?.timestamp, latestAny?.updated_at,
        latestAny?.last_update, latestAny?.date
      ].filter(Boolean);

      if (!cands.length) return null;
      const d = new Date(cands[0]);
      return isNaN(d.getTime()) ? null : d;
    }

    function setLastUpdateFromJson(json){
      const el = document.getElementById("lastUpdate");
      const d = pickLastUpdate(json);
      el.textContent = d
        ? d.toLocaleString("es-ES", { weekday:"short", year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" })
        : "â€”";
    }

    function valueFromLatest(latest, id, kind){
      // kind: "sensors" | "drivers"
      // Soportamos:
      // - latest.sensors.S9 = 52.3
      // - latest.sensors.S9.value = 52.3
      // - latest.S9 = 52.3
      // - latest.drivers.D1 ...
      const l = safeObj(latest);

      const bucket = safeObj(l[kind]);
      let v = bucket[id];

      if (v && typeof v === "object") {
        v = v.value ?? v.v ?? v.last ?? v.reading ?? v.val;
      }
      if (v == null) v = l[id];
      if (v && typeof v === "object") v = v.value ?? v.v;
      const n = Number(String(v).replace(",", "."));
      return Number.isFinite(n) ? n : NaN;
    }

    // =========================
    // Render
    // =========================
    async function loadStatsFromTxt(txtFile){
      const txt = await fetchText(txtFile);
      const series = parseSeriesFromTxt(txt);
      const values = series.map(p => Number(p.v)).filter(Number.isFinite);
      const stats = computeStats(values);
      return { series, stats };
    }

    async function renderAll(){
      const tagsDrivers = document.getElementById("tagsDrivers");
      const tagsSensors = document.getElementById("tagsSensors");
      const miniTable = document.getElementById("miniTable");

      tagsDrivers.innerHTML = "";
      tagsSensors.innerHTML = "";
      miniTable.innerHTML = `<tr><td>Cargandoâ€¦</td><td>â€”</td></tr>`;

      // 1) Carga manifests (nombres)
      const [sensorsManifestRaw, driversManifestRaw] = await Promise.all([
        fetchJson("sensors_manifest.json"),
        fetchJson("drivers_manifest.json")
      ]);

      const sensorsList = normalizeManifest(sensorsManifestRaw, "sensors");
      const driversList = normalizeManifest(driversManifestRaw, "drivers");

      // 2) Carga latest (Ãºltimas lecturas) - probamos varios, sin inventar
      //    Si no existe uno, seguimos con los otros.
      let latestAll = null, latestSensors = null, latestDrivers = null;

      const tryLoad = async (fn) => { try { return await fn(); } catch { return null; } };

      latestAll = await tryLoad(() => fetchJson("latest_all.json"));
      latestSensors = await tryLoad(() => fetchJson("latest.json"));
      latestDrivers = await tryLoad(() => fetchJson("drivers_latest.json"));

      const latestForDate = latestAll || latestSensors || latestDrivers || {};
      setLastUpdateFromJson(latestForDate);

      // 3) S9 REAL desde S9.txt (grÃ¡fica + stats)
      const s9Txt = (sensorsList.find(s => String(s.id).toUpperCase() === "S9")?.file) || "S9.txt";
      const s9 = await loadStatsFromTxt(s9Txt);
      // Limitamos puntos por rendimiento (si tiene miles de lÃ­neas)
      const seriesTrim = s9.series.slice(-600);
      updateChartFromSeries(seriesTrim);

      // 4) Etiquetas SONDAS: stats desde TXT (cada S*.txt)
      //    Para no saturar el navegador, hacemos carga concurrente "limitada"
      async function mapLimit(items, limit, mapper){
        const out = [];
        let i = 0;
        const workers = Array.from({length: limit}, async () => {
          while (i < items.length){
            const idx = i++;
            out[idx] = await mapper(items[idx], idx);
          }
        });
        await Promise.all(workers);
        return out;
      }

      // Sensors
      const sensorsSorted = sensorsList
        .slice()
        .sort((a,b)=> String(a.id).localeCompare(String(b.id), "es", {numeric:true}));

      const sensorsStats = await mapLimit(sensorsSorted, 6, async (s) => {
        const txtFile = s.file || SENSOR_TXT(s.id);
        const { stats } = await loadStatsFromTxt(txtFile);
        // Si quieres, podrÃ­as comparar stats.last con latest JSON, pero NO lo forzamos.
        // (por si el JSON tiene la Ãºltima lectura y el TXT tambiÃ©n; normalmente coinciden)
        return { ...s, txtFile, stats };
      });

      // Drivers
      const driversSorted = driversList
        .slice()
        .sort((a,b)=> String(a.id).localeCompare(String(b.id), "es", {numeric:true}));

      const driversStats = await mapLimit(driversSorted, 6, async (d) => {
        const txtFile = d.file || DRIVER_TXT(d.id);
        const { stats } = await loadStatsFromTxt(txtFile);
        return { ...d, txtFile, stats };
      });

      // 5) Pintar tags (primero S9 destacado)
      // S9 destacado usando stats reales ya cargadas
      const s9Name = sensorsList.find(s => String(s.id).toUpperCase() === "S9")?.name || "S9";
      buildTag(tagsSensors, `${s9Name} (S9)`, s9.stats);

      for (const s of sensorsStats){
        if (String(s.id).toUpperCase() === "S9") continue;
        buildTag(tagsSensors, `${s.name} (${s.id})`, s.stats);
      }

      for (const d of driversStats){
        buildTag(tagsDrivers, `${d.name} (${d.id})`, d.stats);
      }

      // 6) Mini resumen (sin inventar: usamos stats calculadas de TXT)
      const rows = [];

      rows.push([`S9 (Ãºlt/media/mÃ¡x/mÃ­n)`, `${fmt(s9.stats.last)} / ${fmt(s9.stats.avg)} / ${fmt(s9.stats.max)} / ${fmt(s9.stats.min)}`]);

      // top 10 sensores
      sensorsStats
        .filter(s => String(s.id).toUpperCase() !== "S9")
        .slice(0, 10)
        .forEach(s => rows.push([`${s.id} Â· ${s.name}`, `${fmt(s.stats.last)} (avg ${fmt(s.stats.avg)})`]));

      // top 10 drivers
      driversStats.slice(0, 10)
        .forEach(d => rows.push([`${d.id} Â· ${d.name}`, `${fmt(d.stats.last)} (avg ${fmt(d.stats.avg)})`]));

      miniTable.innerHTML = rows.map(r => `<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join("");
    }

    // =========================
    // Init + Refresh
    // =========================
    initChart();

    async function cycle(){
      try{
        setConnection(false, "cargandoâ€¦");
        await renderAll();
        setConnection(true, "online");
      }catch(e){
        console.error(e);
        setConnection(false, "error de carga");
        // Mostramos el error mÃ­nimo sin romper diseÃ±o
        const miniTable = document.getElementById("miniTable");
        miniTable.innerHTML = `<tr><td>Error</td><td>${String(e.message || e)}</td></tr>`;
      }
    }

    cycle();
    setInterval(cycle, REFRESH_MS);
  </script>
</body>
</html>
