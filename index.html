<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sensores ACS</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    canvas {
      max-width: 100%;
      height: 80vh;
    }
  </style>
</head>
<body>

<h1>Sensores ACS</h1>
<p>
  Histórico automático cada 15 minutos.<br>
  Zoom con rueda · Pan arrastrando · Click en leyenda para ocultar/mostrar sensores
</p>

<button onclick="resetZoom()">Reset zoom</button>

<canvas id="chart"></canvas>

<script>
async function loadTextFile(url) {
  const res = await fetch(url);
  const text = await res.text();
  return text
    .split("\n")
    .map(l => l.trim())
    .filter(l => l && !l.endsWith("NOT_FOUND"))
    .map(l => {
      const [ts, val] = l.split(";");
      return { x: new Date(ts), y: parseFloat(val) };
    });
}

async function init() {
  const manifest = await fetch("data/acs_manifest.json").then(r => r.json());

  const datasets = [];

  for (const sensor of manifest.acs) {
    const data = await loadTextFile("data/" + sensor.file);

    if (data.length === 0) continue;

    datasets.push({
      label: `${sensor.item} – ${sensor.label}`,
      data,
      borderWidth: 2,
      pointRadius: 2,
      tension: 0.2
    });
  }

  const ctx = document.getElementById("chart");

  window.chart = new Chart(ctx, {
    type: "line",
    data: { datasets },
    options: {
      parsing: false,
      responsive: true,
      interaction: {
        mode: "nearest",
        intersect: false
      },
      scales: {
        x: {
          type: "time",
          time: { tooltipFormat: "yyyy-MM-dd HH:mm" },
          title: { display: true, text: "Fecha y hora" }
        },
        y: {
          title: { display: true, text: "Temperatura (°C)" }
        }
      },
      plugins: {
        zoom: {
          zoom: {
            wheel: { enabled: true },
            pinch: { enabled: true },
            mode: "x"
          },
          pan: {
            enabled: true,
            mode: "x"
          }
        }
      }
    }
  });
}

function resetZoom() {
  chart.resetZoom();
}

init();
</script>

</body>
</html>
