<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BMS Â· Index</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#070A12; --bg1:#0B1020; --txt:#EAF0FF;
      --muted: rgba(234,240,255,.68); --muted2: rgba(234,240,255,.45);
      --stroke: rgba(255,255,255,.10); --stroke2: rgba(255,255,255,.16);
      --shadow: 0 18px 45px rgba(0,0,0,.45); --r:18px;
      --ok:#35D07F; --bad:#FF5C5C; --accent:#7C5CFF; --accent2:#3BE7FF;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(124,92,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 10%, rgba(59,231,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .wrap{max-width:1280px;margin:0 auto;padding:22px 16px 60px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius:calc(var(--r)+4px); box-shadow:var(--shadow); backdrop-filter: blur(10px);
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:
        radial-gradient(10px 10px at 30% 35%, rgba(255,255,255,.8), transparent 55%),
        linear-gradient(135deg, rgba(124,92,255,1), rgba(59,231,255,1));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 28px rgba(124,92,255,.25);
    }
    .brand h1{margin:0;font-size:14px;line-height:1.1;font-weight:900}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px;font-weight:800}
    .nav{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--stroke2); background:rgba(255,255,255,.06);
      color:var(--txt); text-decoration:none; font-weight:900; font-size:13px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(180deg,var(--accent),var(--accent2));box-shadow:0 0 0 4px rgba(124,92,255,.14)}
    .status{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px; border-radius:999px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      color:var(--muted); font-size:12px; font-weight:900;
    }
    .led{width:8px;height:8px;border-radius:999px;background:var(--bad);box-shadow:0 0 0 4px rgba(255,92,92,.12)}
    .led.ok{background:var(--ok);box-shadow:0 0 0 4px rgba(53,208,127,.12)}

    .grid{margin-top:16px;display:grid;grid-template-columns:1.25fr .75fr;gap:16px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius:var(--r); box-shadow:var(--shadow); backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .head{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;gap:10px;align-items:center}
    .head h2{margin:0;font-size:14px;font-weight:900}
    .head .hint{font-size:12px;color:var(--muted);font-weight:900}
    .body{padding:14px 16px}

    .section{margin-top:14px;color:var(--muted);font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:.2px}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .tag{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      flex:1 1 280px; min-width:280px;
    }
    .chip{
      width:36px;height:36px;border-radius:12px;
      background:
        radial-gradient(10px 10px at 30% 35%, rgba(255,255,255,.7), transparent 55%),
        linear-gradient(135deg, rgba(124,92,255,.95), rgba(59,231,255,.85));
      border:1px solid rgba(255,255,255,.14);
      flex:0 0 auto;
    }
    .k{min-width:0}
    .name{font-weight:900;font-size:13px}
    .desc{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px}
    .vals{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .vb{padding:7px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.20);min-width:86px;text-align:right}
    .lab{font-size:10px;color:var(--muted2);font-weight:900;text-transform:uppercase;letter-spacing:.6px}
    .num{font-size:13px;font-weight:900;margin-top:2px}

    .mini{width:100%;border-collapse:separate;border-spacing:0 8px}
    .mini td{padding:10px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10)}
    .mini td:first-child{border-radius:14px 0 0 14px;font-weight:900}
    .mini td:last-child{border-radius:0 14px 14px 0;text-align:right;color:var(--muted);font-weight:900}

    .note{margin-top:10px;color:var(--muted2);font-size:12px;font-weight:700}
    .svgWrap{height:340px;padding:10px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18)}
    .svgWrap svg{width:100%;height:100%}
    .axisText{fill:rgba(234,240,255,.55);font-size:11px;font-weight:800}
    .gridLine{stroke:rgba(255,255,255,.08);stroke-width:1}
    .line{fill:none;stroke:rgba(59,231,255,.95);stroke-width:2}
    .area{fill:rgba(59,231,255,.12)}
    .pt{fill:rgba(234,240,255,.9)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>BMS Â· Sala de Calderas</h1>
          <div class="sub">Index Â· sin manifests (S*.txt + drv_D*.txt + latest_all/latest)</div>
        </div>
      </div>

      <div class="nav">
        <a class="btn" href="esquema.html"><span class="dot"></span> Esquema</a>
        <a class="btn" href="visor.html"><span class="dot"></span> Visor</a>
      </div>

      <div class="status">
        <span id="led" class="led"></span>
        <span id="statusText">cargandoâ€¦</span>
        <span style="opacity:.6">Â·</span>
        <span id="lastUpdate">â€”</span>
      </div>
    </div>

    <div class="grid">
      <!-- IZQ -->
      <div class="card">
        <div class="head">
          <h2>ðŸ“ˆ S9 (puntos reales)</h2>
          <div class="hint">S9.txt</div>
        </div>
        <div class="body">
          <div class="svgWrap">
            <svg id="s9svg" viewBox="0 0 1000 340" preserveAspectRatio="none"></svg>
          </div>

          <div class="section">Drivers (drv_D*.txt)</div>
          <div class="tags" id="driversTags"></div>

          <div class="section">Sondas (S*.txt)</div>
          <div class="tags" id="sensorsTags"></div>

          <div class="note">
            âœ… Ãšltimo valor: desde <b>latest_all.json</b> (preferido) o <b>latest.json</b> (fallback).<br>
            âœ… Media/mÃ¡x/mÃ­n: desde cada <b>.txt</b>.<br>
            âœ… IDs detectados leyendo las claves del JSON (no manifests).
          </div>
        </div>
      </div>

      <!-- DCHA -->
      <div class="card">
        <div class="head">
          <h2>ðŸ§¾ DiagnÃ³stico</h2>
          <div class="hint">simple</div>
        </div>
        <div class="body">
          <table class="mini" id="mini">
            <tr><td>Estado</td><td>â€”</td></tr>
          </table>
          <div class="note">Si algo falla, aquÃ­ saldrÃ¡ el fichero exacto que no se pudo leer.</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ============================
  // Config mÃ­nima
  // ============================
  const REFRESH_MS = 60_000;
  const SENSOR_TXT = (id) => `${id}.txt`;
  const DRIVER_TXT = (id) => `drv_${id}.txt`;
  const MAX_POINTS_S9 = 400;
  const FETCH_CONCURRENCY = 6;

  // ============================
  // Helpers
  // ============================
  const $ = (id) => document.getElementById(id);
  const safeObj = (x) => (x && typeof x === "object") ? x : {};
  const fmt = (n) => (Number.isFinite(n) ? (Math.round(n*100)/100).toFixed(2) : "â€”");

  function setStatus(ok, text){
    $("led").classList.toggle("ok", !!ok);
    $("statusText").textContent = text;
  }

  async function fetchJson(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`No puedo leer ${url} (HTTP ${r.status})`);
    return r.json();
  }
  async function fetchText(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(`No puedo leer ${url} (HTTP ${r.status})`);
    return r.text();
  }

  // TXT: saca valores (Ãºltimo nÃºmero por lÃ­nea)
  function parseValuesFromTxt(txt){
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const values = [];
    for (const line of lines){
      const m = line.match(/(-?\d+(?:[.,]\d+)?)(?!.*-?\d)/);
      if(!m) continue;
      const v = Number(m[1].replace(",", "."));
      if(!Number.isFinite(v)) continue;
      values.push(v);
    }
    return values;
  }

  function statsFromValues(values){
    const arr = values.filter(Number.isFinite);
    if(!arr.length) return { avg: NaN, min: NaN, max: NaN };
    const min = Math.min(...arr);
    const max = Math.max(...arr);
    const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
    return { avg, min, max };
  }

  function addTag(container, id, lastValue, stats){
    const el = document.createElement("div");
    el.className = "tag";
    el.innerHTML = `
      <div class="chip"></div>
      <div class="k">
        <div class="name">${id}</div>
        <div class="desc">Ãšltimo (JSON) + Media/MÃ¡x/MÃ­n (TXT)</div>
      </div>
      <div class="vals">
        <div class="vb"><div class="lab">Ãšlt</div><div class="num">${fmt(lastValue)}</div></div>
        <div class="vb"><div class="lab">Media</div><div class="num">${fmt(stats.avg)}</div></div>
        <div class="vb"><div class="lab">MÃ¡x</div><div class="num">${fmt(stats.max)}</div></div>
        <div class="vb"><div class="lab">MÃ­n</div><div class="num">${fmt(stats.min)}</div></div>
      </div>
    `;
    container.appendChild(el);
  }

  // Concurrencia limitada
  async function mapLimit(items, limit, fn){
    const out = new Array(items.length);
    let i = 0;
    const workers = Array.from({length: limit}, async () => {
      while(true){
        const idx = i++;
        if(idx >= items.length) break;
        out[idx] = await fn(items[idx], idx);
      }
    });
    await Promise.all(workers);
    return out;
  }

  // Latest JSON (prefer latest_all)
  async function loadLatest(){
    try { return await fetchJson("latest_all.json"); }
    catch { return await fetchJson("latest.json"); }
  }

  function setLastUpdate(latest){
    const ts = latest.ts || latest.timestamp || latest.updated_at || latest.last_update || "";
    const d = new Date(ts);
    $("lastUpdate").textContent = (!ts || isNaN(d.getTime())) ? "â€”" : d.toLocaleString("es-ES");
  }

  function extractIdsFromLatest(latest){
    // Detecta sensores S* y drivers D* leyendo claves del JSON (SIN manifests)
    // Soporta estructuras:
    // - latest.S1, latest.S9, latest.D1...
    // - latest.sensors.S9 / latest.drivers.D1
    const L = safeObj(latest);

    const sensorIds = new Set();
    const driverIds = new Set();

    // claves directas
    for (const k of Object.keys(L)){
      if (/^S\d+$/i.test(k)) sensorIds.add(k.toUpperCase());
      if (/^D\d+$/i.test(k)) driverIds.add(k.toUpperCase());
    }

    // dentro de buckets tÃ­picos
    const sensorsBucket = safeObj(L.sensors || L.S);
    const driversBucket = safeObj(L.drivers || L.D);

    for (const k of Object.keys(sensorsBucket)){
      if (/^S\d+$/i.test(k)) sensorIds.add(k.toUpperCase());
    }
    for (const k of Object.keys(driversBucket)){
      if (/^D\d+$/i.test(k)) driverIds.add(k.toUpperCase());
    }

    return {
      sensors: Array.from(sensorIds).sort((a,b)=>a.localeCompare(b,"es",{numeric:true})),
      drivers: Array.from(driverIds).sort((a,b)=>a.localeCompare(b,"es",{numeric:true}))
    };
  }

  function getLastValue(latest, id){
    // Busca id en varias rutas
    const L = safeObj(latest);

    const candidates = [
      () => L[id],
      () => (L.sensors && L.sensors[id]),
      () => (L.drivers && L.drivers[id]),
      () => (L.S && L.S[id]),
      () => (L.D && L.D[id]),
    ];

    let v;
    for (const f of candidates){
      const x = f();
      if (x == null) continue;
      v = (x && typeof x === "object") ? (x.value ?? x.v ?? x.last ?? x.val) : x;
      if (v != null) break;
    }
    const n = Number(String(v).replace(",", "."));
    return Number.isFinite(n) ? n : NaN;
  }

  // ============================
  // SVG chart S9 (simple)
  // ============================
  function drawS9(values){
    const svg = $("s9svg");
    svg.innerHTML = "";

    const W = 1000, H = 340;
    const padL = 40, padR = 10, padT = 12, padB = 22;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    const v = values.slice(-MAX_POINTS_S9);
    if (v.length < 2){
      svg.innerHTML = `<text x="40" y="40" class="axisText">Sin datos suficientes en S9.txt</text>`;
      return;
    }

    const min = Math.min(...v), max = Math.max(...v);
    const span = (max - min) || 1;

    for(let k=0;k<=4;k++){
      const y = padT + (plotH * k/4);
      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1", padL); line.setAttribute("x2", W-padR);
      line.setAttribute("y1", y); line.setAttribute("y2", y);
      line.setAttribute("class","gridLine");
      svg.appendChild(line);

      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x", 6);
      t.setAttribute("y", y+4);
      t.setAttribute("class","axisText");
      t.textContent = fmt(max - span*(k/4));
      svg.appendChild(t);
    }

    const pts = v.map((val,i)=>{
      const x = padL + (plotW * (i/(v.length-1)));
      const y = padT + (plotH * (1 - ((val - min)/span)));
      return [x,y];
    });

    const d = pts.map((p,i)=> (i===0?`M ${p[0]} ${p[1]}`:`L ${p[0]} ${p[1]}`)).join(" ");
    const areaD = `M ${pts[0][0]} ${H-padB} ` + pts.map(p=>`L ${p[0]} ${p[1]}`).join(" ") + ` L ${pts[pts.length-1][0]} ${H-padB} Z`;

    const area = document.createElementNS("http://www.w3.org/2000/svg","path");
    area.setAttribute("d", areaD);
    area.setAttribute("class","area");
    svg.appendChild(area);

    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d", d);
    path.setAttribute("class","line");
    svg.appendChild(path);

    const last = pts[pts.length-1];
    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx", last[0]); c.setAttribute("cy", last[1]); c.setAttribute("r", 3.2);
    c.setAttribute("class","pt");
    svg.appendChild(c);
  }

  // ============================
  // Main
  // ============================
  async function cycle(){
    const mini = $("mini");
    const driversTags = $("driversTags");
    const sensorsTags = $("sensorsTags");

    driversTags.innerHTML = "";
    sensorsTags.innerHTML = "";
    mini.innerHTML = `<tr><td>Estado</td><td>cargandoâ€¦</td></tr>`;
    setStatus(false, "cargandoâ€¦");

    try{
      // 1) latest (para IDs y Ãºltimos valores)
      const latest = await loadLatest();
      setLastUpdate(latest);

      const ids = extractIdsFromLatest(latest);
      const sensorIds = ids.sensors;
      const driverIds = ids.drivers;

      // 2) S9 chart real
      const s9txt = await fetchText("S9.txt");
      const s9vals = parseValuesFromTxt(s9txt);
      drawS9(s9vals);

      // 3) Tags sensores: S*.txt + last JSON
      await mapLimit(sensorIds, FETCH_CONCURRENCY, async (sid) => {
        const txt = await fetchText(SENSOR_TXT(sid));
        const values = parseValuesFromTxt(txt);
        const st = statsFromValues(values);
        const last = getLastValue(latest, sid);
        addTag(sensorsTags, sid, last, st);
      });

      // 4) Tags drivers: drv_D*.txt + last JSON
      await mapLimit(driverIds, FETCH_CONCURRENCY, async (did) => {
        const txt = await fetchText(DRIVER_TXT(did));
        const values = parseValuesFromTxt(txt);
        const st = statsFromValues(values);
        const last = getLastValue(latest, did);
        addTag(driversTags, did, last, st);
      });

      mini.innerHTML = `
        <tr><td>latest</td><td>${(latest_all_used = !!latest && !!latest.ts) ? "OK" : "OK"}</td></tr>
        <tr><td>Sensores detectados</td><td>${sensorIds.length}</td></tr>
        <tr><td>Drivers detectados</td><td>${driverIds.length}</td></tr>
        <tr><td>S9 puntos</td><td>${s9vals.length}</td></tr>
      `;

      setStatus(true, "online");
    }catch(e){
      console.error(e);
      mini.innerHTML = `<tr><td>Error</td><td>${String(e.message || e)}</td></tr>`;
      setStatus(false, "error");
    }
  }

  cycle();
  setInterval(cycle, REFRESH_MS);
</script>
</body>
</html>
