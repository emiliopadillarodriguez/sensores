<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ACS y Calefaccion de Arribes del duero</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{--bg:#0b1220;--text:#e7eefc;--muted:#a9b8d6;--line:rgba(255,255,255,.10);--shadow:0 12px 40px rgba(0,0,0,.35);--radius:18px;--bad:#ff6b6b;--ok:#3ddc97;--accent:#7aa7ff;--accent2:#7cffa6;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:radial-gradient(1200px 800px at 20% 0%, rgba(122,167,255,.25), transparent 55%),radial-gradient(1000px 800px at 80% 10%, rgba(124,255,166,.18), transparent 60%),var(--bg);color:var(--text);}
    header{padding:22px 18px 10px;max-width:1280px;margin:0 auto;}
    h1{margin:0 0 10px;font-size:clamp(22px,3vw,34px);}
    .sub{color:var(--muted);display:flex;flex-wrap:wrap;gap:10px 16px;align-items:center;font-size:14px;}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.04);}
    .mono{font-family:ui-monospace,Consolas,Menlo,monospace;}

    .wrap{max-width:1280px;margin:0 auto;padding:12px 18px 32px;display:grid;grid-template-columns:1.15fr .85fr;gap:16px;}
    @media (max-width:980px){.wrap{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;background:rgba(0,0,0,.18);}
    .hd h2{margin:0;font-size:16px;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .btn{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);padding:10px 12px;border-radius:14px;text-decoration:none;font-weight:750;font-size:14px;display:inline-flex;align-items:center;gap:10px;cursor:pointer;}
    .btn:hover{background:rgba(255,255,255,.10);}
    .btn.primary{background:linear-gradient(90deg, rgba(122,167,255,.25), rgba(124,255,166,.18));}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 0 4px rgba(122,167,255,.18);}
    .btn.primary .dot{background:var(--accent2);box-shadow:0 0 0 4px rgba(124,255,166,.14);}

    .grid{padding:14px;display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}

    .tile{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:16px;padding:10px 10px 12px;text-align:left;cursor:pointer;}
    .tile:hover{background:rgba(255,255,255,.07);}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px;}
    .tag{font-weight:900;font-size:13px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);}
    .status{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);}
    .status.ok{color:var(--ok)} .status.bad{color:var(--bad)}
    .value{font-size:18px;font-weight:900;margin-bottom:4px;}
    .label{font-size:12px;color:var(--muted);min-height:30px;line-height:1.25;}
    .meta{font-size:12px;color:var(--muted);margin-top:6px;}

    .chartWrap{padding:12px 14px 16px;}
    canvas{width:100%!important;height:320px!important;}
    .err{padding:14px;color:var(--bad);}
  </style>
</head>

<body>
<header>
  <h1>ACS y Calefaccion de Arribes del duero</h1>
  <div class="sub">
    <span class="pill">üìÅ Base usada: <span id="baseUsed" class="mono">‚Äî</span></span>
    <span class="pill">üïí √öltima actualizaci√≥n: <span id="lastUpdate">‚Äî</span></span>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="hd">
      <h2>√öltima lectura (S + D)</h2>
      <div class="actions">
        <a class="btn primary" href="esquema.html"><span class="dot"></span> Esquema</a>
        <a class="btn" href="visor.html"><span class="dot"></span> Visor</a>
        <button class="btn" id="btnRefresh"><span class="dot"></span> Actualizar</button>
      </div>
    </div>
    <div class="grid" id="tiles"></div>
  </section>

  <aside class="card">
    <div class="hd">
      <h2>Gr√°fica S9</h2>
      <div class="actions"><span class="pill">üìà Hist√≥rico: <span class="mono">S9.txt</span></span></div>
    </div>
    <div class="chartWrap">
      <canvas id="chartS9"></canvas>
    </div>
  </aside>
</main>

<script>
(() => {
  const BASE_CANDIDATES = ["data/", "sensores/data/"]; // <-- aqu√≠ est√° la clave
  const elTiles = document.getElementById("tiles");
  const elLastUpdate = document.getElementById("lastUpdate");
  const elBaseUsed = document.getElementById("baseUsed");
  const btnRefresh = document.getElementById("btnRefresh");

  let base = null;
  let chart = null;

  const safeText = (v) => (v === null || v === undefined) ? "" : String(v);
  const prettyTs = (ts) => {
    try { const d = new Date(ts); return isNaN(d.getTime()) ? ts : d.toLocaleString(); }
    catch { return ts; }
  };

  function sortKey(id){
    const m = /^([SD])(\d+)/i.exec(id);
    if (!m) return [9e9, 9e9];
    return [m[1].toUpperCase()==="S"?0:1, Number(m[2])];
  }

  async function fetchJSON(url){
    const r = await fetch(url, { cache:"no-store" });
    if (!r.ok) throw new Error(`HTTP ${r.status} ${url}`);
    return r.json();
  }

  async function fetchText(url){
    const r = await fetch(url, { cache:"no-store" });
    if (!r.ok) throw new Error(`HTTP ${r.status} ${url}`);
    return r.text();
  }

  async function detectBase(){
    for (const b of BASE_CANDIDATES){
      try{
        await fetchJSON(b + "latest_all.json");
        return b;
      }catch(e){ /* probar siguiente */ }
    }
    throw new Error("No se encuentra latest_all.json en ninguna ruta");
  }

  async function loadLatestAll(){
    const j = await fetchJSON(base + "latest_all.json");
    const ts = j.timestamp_utc || null;

    const raw = Array.isArray(j.items)
      ? j.items
      : ([]).concat(Array.isArray(j.sensors)?j.sensors:[], Array.isArray(j.drivers)?j.drivers:[]);

    const items = raw
      .filter(x => x && x.item)
      .map(x => ({
        item: String(x.item).toUpperCase(),
        label: safeText(x.label),
        value: safeText(x.value),
        units: safeText(x.units),
        timestamp_utc: ts
      }))
      .sort((a,b)=>{
        const ka=sortKey(a.item), kb=sortKey(b.item);
        return ka[0]-kb[0] || ka[1]-kb[1] || a.item.localeCompare(b.item);
      });

    return { ts, i
