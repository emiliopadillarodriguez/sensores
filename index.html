<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BMS - Panel</title>

  <!-- Chart.js (CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#101f38;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --ok:#00c853;
      --warn:#ffb300;
      --bad:#ff5252;
      --chip:#15264a;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #15264a 0%, var(--bg) 55%) fixed;
      color:var(--text);
    }

    a{color:inherit; text-decoration:none}
    .wrap{max-width:1280px; margin:0 auto; padding:18px;}

    /* Topbar */
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top: 10px; z-index: 20;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 240px;
    }
    .dot{
      width:12px; height:12px; border-radius:999px;
      background: var(--ok);
      box-shadow: 0 0 18px rgba(0,200,83,.55);
    }
    .brand h1{
      font-size:14px; margin:0; letter-spacing:.2px;
    }
    .brand small{display:block; color:var(--muted); margin-top:2px}

    .nav{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
    }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      font-size: 13px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn.primary{
      background: rgba(0,200,83,.14);
      border-color: rgba(0,200,83,.28);
    }

    .right{
      display:flex; align-items:center; gap:10px; justify-content:flex-end;
      min-width: 260px;
      flex-wrap:wrap;
    }
    .pill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }

    /* Grid */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:14px;
    }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
    }
    .card .hd h2{
      margin:0; font-size:13px; letter-spacing:.2px;
      color: rgba(255,255,255,.88);
    }
    .card .bd{padding:14px}

    /* KPI chips */
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    .kpi{
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      border-radius: 16px;
      padding:10px 12px;
      min-height:72px;
    }
    .kpi .t{font-size:12px; color:var(--muted)}
    .kpi .v{font-size:20px; font-weight:650; margin-top:6px; letter-spacing:.2px}
    .kpi .s{font-size:12px; color:var(--muted); margin-top:2px}

    /* Chart area */
    .chartWrap{
      height: 320px;
    }
    canvas{display:block; width:100% !important; height:100% !important;}

    /* Lists */
    .chips{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }

    /* Drivers status */
    .statusGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .item{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .item .name{
      font-size:12px;
      color: rgba(255,255,255,.86);
      line-height: 1.2;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      white-space:nowrap;
    }
    .badge.on{
      background: rgba(0,200,83,.16);
      border-color: rgba(0,200,83,.30);
      color: rgba(255,255,255,.92);
    }
    .badge.off{
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.65);
    }

    /* Table */
    table{
      width:100%;
      border-collapse: collapse;
      font-size:12px;
      overflow:hidden;
      border:1px solid var(--stroke);
      border-radius: 14px;
    }
    th, td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
      vertical-align: top;
    }
    th{
      color: rgba(255,255,255,.78);
      background: rgba(255,255,255,.03);
      font-weight:600;
      position: sticky;
      top: 0;
    }
    tr:hover td{background: rgba(255,255,255,.03)}

    .muted{color:var(--muted)}
    .error{
      border:1px solid rgba(255,82,82,.35);
      background: rgba(255,82,82,.10);
      color: rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius: 14px;
      font-size:12px;
    }

    /* Responsive */
    @media (max-width: 1100px){
      .grid{grid-template-columns: 1fr;}
      .right{min-width:auto}
      .brand{min-width:auto}
      .kpis{grid-template-columns: repeat(2, minmax(0,1fr));}
      .statusGrid{grid-template-columns: 1fr;}
      .chartWrap{height: 280px;}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <span class="dot" id="liveDot" title="Estado"></span>
        <div>
          <h1>Panel BMS</h1>
          <small id="subtitle">Cargando datos‚Ä¶</small>
        </div>
      </div>

      <div class="nav">
        <!-- Ajusta estos enlaces a tus p√°ginas reales -->
        <a class="btn primary" href="index.html">üè† Panel</a>
        <a class="btn" href="esquema.html">üó∫Ô∏è Esquema</a>
        <a class="btn" href="visor.html">üìà Visor</a>
      </div>

      <div class="right">
        <button class="btn" id="btnReload">üîÑ Recargar</button>
        <span class="pill" id="lastUpdate">‚Äî</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT COLUMN -->
      <div class="card">
        <div class="hd">
          <h2>Temperaturas ‚Äî S9 (Dep√≥sito ACS) y S10 (Consumo ACS)</h2>
          <div class="chips">
            <span class="chip" id="chipS9">S9: ‚Äî</span>
            <span class="chip" id="chipS10">S10: ‚Äî</span>
          </div>
        </div>
        <div class="bd">
          <div class="kpis">
            <div class="kpi">
              <div class="t">S9 ‚Äî Dep√≥sito ACS</div>
              <div class="v" id="kpiS9">‚Äî</div>
              <div class="s muted" id="kpiS9u">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="t">S10 ‚Äî Consumo ACS</div>
              <div class="v" id="kpiS10">‚Äî</div>
              <div class="s muted" id="kpiS10u">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="t">Bombas ON</div>
              <div class="v" id="kpiOn">‚Äî</div>
              <div class="s muted">drivers en estado ON</div>
            </div>
            <div class="kpi">
              <div class="t">Sondas le√≠das</div>
              <div class="v" id="kpiSCount">‚Äî</div>
              <div class="s muted">sensores disponibles</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="chartWrap">
            <canvas id="chartS9S10"></canvas>
          </div>

          <div style="height:10px"></div>
          <div id="chartHint" class="muted" style="font-size:12px;">
            Consejo: si no ves la gr√°fica en Chrome, prueba Ctrl+F5. Si tu red bloquea CDNs, el panel seguir√° funcionando pero sin Chart.js.
          </div>
          <div id="chartErr" style="margin-top:10px; display:none;"></div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="card">
        <div class="hd">
          <h2>Estado bombas / equipos (Drivers)</h2>
          <span class="chip" id="driversCount">‚Äî</span>
        </div>
        <div class="bd">
          <div class="statusGrid" id="driversGrid"></div>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <!-- SENSORS TABLE -->
    <div class="card">
      <div class="hd">
        <h2>√öltimo valor de todas las sondas (Sensors)</h2>
        <span class="chip" id="sensorsCount">‚Äî</span>
      </div>
      <div class="bd" style="max-height:420px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:90px;">Item</th>
              <th>Etiqueta</th>
              <th style="width:160px;">Valor</th>
              <th style="width:100px;">Unidades</th>
            </tr>
          </thead>
          <tbody id="sensorsTbody"></tbody>
        </table>
      </div>
    </div>

  </div>

<script>
/* =========================
   Helpers de carga robusta
========================= */
async function fetchJsonWithFallback(paths) {
  let lastErr = null;
  for (const p of paths) {
    try {
      const res = await fetch(p + (p.includes("?") ? "" : ("?t=" + Date.now())), { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} en ${p}`);
      return await res.json();
    } catch (e) {
      lastErr = e;
    }
  }
  throw lastErr || new Error("No se pudo cargar JSON");
}

function safeStr(x){ return (x === null || x === undefined) ? "" : String(x).trim(); }

function normalizeOnOff(val){
  const v = safeStr(val).toLowerCase();
  if (["on","1","true","yes","encendida","encendido"].includes(v)) return "on";
  if (["off","0","false","no","apagada","apagado"].includes(v)) return "off";
  return v;
}

function parseHistory(any){
  // Soporta:
  // - Array directo: [{timestamp:.., value:..}, ...]
  // - Object con "history": [...]
  const arr = Array.isArray(any) ? any : (any && Array.isArray(any.history) ? any.history : []);
  return arr.map(r => {
    const ts = r.timestamp || r.ts || r.time || r.datetime || r.date;
    const v  = r.value ?? r.val ?? r.v;
    return { t: ts, v: v };
  }).filter(x => x.t !== undefined && x.v !== undefined);
}

function toNumber(x){
  const n = Number(String(x).replace(",", "."));
  return Number.isFinite(n) ? n : null;
}

function prettyTime(iso){
  try{
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    return d.toLocaleString();
  }catch{ return iso; }
}

/* =========================
   UI refs
========================= */
const subtitle = document.getElementById("subtitle");
const lastUpdate = document.getElementById("lastUpdate");
const liveDot = document.getElementById("liveDot");

const kpiS9  = document.getElementById("kpiS9");
const kpiS10 = document.getElementById("kpiS10");
const kpiS9u = document.getElementById("kpiS9u");
const kpiS10u= document.getElementById("kpiS10u");
const chipS9 = document.getElementById("chipS9");
const chipS10= document.getElementById("chipS10");

const kpiOn = document.getElementById("kpiOn");
const kpiSCount = document.getElementById("kpiSCount");

const sensorsTbody = document.getElementById("sensorsTbody");
const sensorsCount = document.getElementById("sensorsCount");
const driversGrid  = document.getElementById("driversGrid");
const driversCount = document.getElementById("driversCount");

const chartErr = document.getElementById("chartErr");

/* =========================
   Chart
========================= */
let chart = null;

function buildChart(labels, s9, s10){
  if (!window.Chart){
    chartErr.style.display = "block";
    chartErr.className = "error";
    chartErr.textContent = "Chart.js no est√° disponible (bloqueado por red o no carg√≥). El resto del panel funciona.";
    return;
  }
  const ctx = document.getElementById("chartS9S10").getContext("2d");

  const data = {
    labels,
    datasets: [
      {
        label: "S9 ‚Äî Dep√≥sito ACS (¬∞C)",
        data: s9,
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.25
      },
      {
        label: "S10 ‚Äî Consumo ACS (¬∞C)",
        data: s10,
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.25
      }
    ]
  };

  const options = {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: "index", intersect: false },
    plugins: {
      legend: { labels: { color: "rgba(255,255,255,.85)" } },
      tooltip: { enabled: true }
    },
    scales: {
      x: {
        ticks: { color: "rgba(255,255,255,.70)", maxRotation: 0, autoSkip: true },
        grid: { color: "rgba(255,255,255,.08)" }
      },
      y: {
        ticks: { color: "rgba(255,255,255,.70)" },
        grid: { color: "rgba(255,255,255,.08)" }
      }
    }
  };

  if (chart) chart.destroy();
  chart = new Chart(ctx, { type: "line", data, options });
}

/* =========================
   Render: sensores y drivers
========================= */
function renderSensorsTable(sensors){
  sensorsTbody.innerHTML = "";
  for (const s of sensors){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${safeStr(s.item)}</b></td>
      <td class="muted">${safeStr(s.label)}</td>
      <td>${safeStr(s.value)}</td>
      <td class="muted">${safeStr(s.units)}</td>
    `;
    sensorsTbody.appendChild(tr);
  }
  sensorsCount.textContent = `${sensors.length} sensores`;
  kpiSCount.textContent = sensors.length;
}

function renderDrivers(drivers){
  driversGrid.innerHTML = "";
  let onCount = 0;

  for (const d of drivers){
    const state = normalizeOnOff(d.value);
    const isOn = state === "on";
    if (isOn) onCount++;

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div>
        <div class="name"><b>${safeStr(d.item)}</b> ‚Äî ${safeStr(d.label)}</div>
        <div class="muted" style="font-size:12px; margin-top:3px;">Valor: ${safeStr(d.value)}</div>
      </div>
      <span class="badge ${isOn ? "on" : "off"}">${isOn ? "ON" : "OFF"}</span>
    `;
    driversGrid.appendChild(div);
  }

  driversCount.textContent = `${drivers.length} drivers`;
  kpiOn.textContent = onCount;

  // puntito de ‚Äúlive‚Äù en verde si hay datos
  liveDot.style.background = (drivers.length || onCount || true) ? "var(--ok)" : "var(--bad)";
}

/* =========================
   Carga principal
========================= */
async function loadDashboard(){
  subtitle.textContent = "Cargando datos‚Ä¶";
  chartErr.style.display = "none";

  // 1) latest_all
  const latestAll = await fetchJsonWithFallback([
    "data/latest_all.json",
    "latest_all.json"
  ]);

  const ts = latestAll.timestamp_utc || latestAll.timestamp || latestAll.time || "";
  lastUpdate.textContent = ts ? ("√öltima lectura: " + prettyTime(ts)) : "√öltima lectura: ‚Äî";
  subtitle.textContent = "Resumen r√°pido + gr√°ficas clave";

  const sensors = Array.isArray(latestAll.sensors) ? latestAll.sensors : [];
  const drivers = Array.isArray(latestAll.drivers) ? latestAll.drivers : [];

  // KPIs S9/S10
  const s9 = sensors.find(x => safeStr(x.item) === "S9");
  const s10 = sensors.find(x => safeStr(x.item) === "S10");

  if (s9){
    kpiS9.textContent = `${safeStr(s9.value)}`;
    kpiS9u.textContent = `${safeStr(s9.units) || ""}`;
    chipS9.textContent = `S9: ${safeStr(s9.value)} ${safeStr(s9.units)}`;
  } else {
    chipS9.textContent = "S9: ‚Äî";
  }
  if (s10){
    kpiS10.textContent = `${safeStr(s10.value)}`;
    kpiS10u.textContent = `${safeStr(s10.units) || ""}`;
    chipS10.textContent = `S10: ${safeStr(s10.value)} ${safeStr(s10.units)}`;
  } else {
    chipS10.textContent = "S10: ‚Äî";
  }

  // Render tablas/estado
  renderSensorsTable(sensors);
  renderDrivers(drivers);

  // 2) Hist√≥ricos S9 y S10 (para la gr√°fica)
  // Intentamos "data/S9.json" y "S9.json" (seg√∫n tu repo)
  let h9 = [], h10 = [];
  try{
    const raw9 = await fetchJsonWithFallback(["data/S9.json", "S9.json"]);
    h9 = parseHistory(raw9);
  }catch(e){
    console.warn("No se pudo cargar hist√≥rico S9:", e);
  }
  try{
    const raw10 = await fetchJsonWithFallback(["data/S10.json", "S10.json"]);
    h10 = parseHistory(raw10);
  }catch(e){
    console.warn("No se pudo cargar hist√≥rico S10:", e);
  }

  // Unificamos por √≠ndice (simple y robusto)
  const len = Math.max(h9.length, h10.length);
  const labels = [];
  const s9Vals = [];
  const s10Vals = [];

  for (let i=0; i<len; i++){
    const t = (h9[i]?.t || h10[i]?.t || "");
    labels.push(t ? prettyTime(t) : "");
    s9Vals.push(toNumber(h9[i]?.v));
    s10Vals.push(toNumber(h10[i]?.v));
  }

  // Si no hay hist√≥ricos, al menos pintamos 1 punto con los √∫ltimos valores
  if (len === 0){
    labels.push(ts ? prettyTime(ts) : "Ahora");
    s9Vals.push(toNumber(s9?.value));
    s10Vals.push(toNumber(s10?.value));
  }

  buildChart(labels, s9Vals, s10Vals);
}

/* =========================
   Arranque + refresco
========================= */
document.getElementById("btnReload").addEventListener("click", () => {
  loadDashboard().catch(err => {
    console.error(err);
    subtitle.textContent = "Error cargando datos";
    chartErr.style.display = "block";
    chartErr.className = "error";
    chartErr.textContent = "Error: no se pudo cargar latest_all.json o hist√≥ricos. Revisa rutas/nombres de archivo.";
  });
});

// Auto-refresh cada 60s
setInterval(() => {
  loadDashboard().catch(console.warn);
}, 60000);

// Primer arranque
loadDashboard().catch(err => {
  console.error(err);
  subtitle.textContent = "Error cargando datos";
  chartErr.style.display = "block";
  chartErr.className = "error";
  chartErr.textContent = "Error: no se pudo cargar latest_all.json o hist√≥ricos. Revisa rutas/nombres de archivo.";
});
</script>

</body>
</html>
