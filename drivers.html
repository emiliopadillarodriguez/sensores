<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drivers - Bombas y equipos</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>

  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 16px; }
    h1 { margin: 0 0 6px; }
    .sub { color:#444; margin: 0 0 14px; }
    .card { border:1px solid #ddd; border-radius:12px; padding:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    select, button { padding:6px 10px; }
    button { cursor:pointer; }
    .status { font-weight:700; }
    .ok { color: #0a7a0a; }
    .warn { color: #b35b00; }
    canvas { width:100% !important; height:420px !important; }
  </style>
</head>

<body>
  <h1>Drivers (Bombas / Equipos)</h1>
  <p class="sub">Gráfica de estado: 0 = OFF, 1 = ON · Zoom con rueda · Pan arrastrando</p>

  <div class="card">
    <div class="row">
      <label for="driverSel"><b>Selecciona Driver:</b></label>
      <select id="driverSel">
        <option value="D1">D1 – M-P B. 5.2 (Calefacción / Primario caldera 2)</option>
      </select>

      <button id="btnReload">Recargar</button>
      <button id="btnReset">Reset zoom</button>

      <span id="last" class="status"></span>
    </div>

    <canvas id="chart"></canvas>
  </div>

<script>
  const ctx = document.getElementById("chart");
  const driverSel = document.getElementById("driverSel");
  const lastEl = document.getElementById("last");
  const btnReload = document.getElementById("btnReload");
  const btnReset  = document.getElementById("btnReset");

  function parseOnOff(v) {
    const s = String(v || "").trim().toLowerCase();
    if (s === "on") return 1;
    if (s === "off") return 0;
    return null;
  }

  async function loadTxt(driverId) {
    const url = `data/drv_${driverId}.txt?ts=${Date.now()}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`No se pudo leer ${url} (${res.status})`);
    const txt = await res.text();

    const points = [];
    const lines = txt.split(/\r?\n/).filter(Boolean);

    for (const line of lines) {
      const [ts, val] = line.split(";");
      const y = parseOnOff(val);
      if (!ts || y === null) continue;
      points.push({ x: new Date(ts), y });
    }
    return points;
  }

  function updateLast(points) {
    if (!points.length) {
      lastEl.textContent = "Sin datos";
      lastEl.className = "status warn";
      return;
    }
    const last = points[points.length - 1];
    const state = last.y === 1 ? "ON" : "OFF";
    lastEl.textContent = `Último: ${state} · ${last.x.toISOString()}`;
    lastEl.className = "status " + (last.y === 1 ? "ok" : "warn");
  }

  const chart = new Chart(ctx, {
    type: "line",
    data: {
      datasets: [{
        label: "Estado (0=OFF,1=ON)",
        data: [],
        stepped: true,
        pointRadius: 0,
        borderWidth: 2,
      }]
    },
    options: {
      parsing: false,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: "time",
          time: { tooltipFormat: "yyyy-MM-dd HH:mm:ss" },
          title: { display: true, text: "Fecha y hora" }
        },
        y: {
          min: -0.1,
          max: 1.1,
          ticks: {
            stepSize: 1,
            callback: (v) => (v === 1 ? "ON" : (v === 0 ? "OFF" : v))
          },
          title: { display: true, text: "Estado" }
        }
      },
      plugins: {
        legend: { display: true },
        zoom: {
          pan: { enabled: true, mode: "x" },
          zoom: {
            wheel: { enabled: true },
            pinch: { enabled: true },
            mode: "x"
          }
        },
        tooltip: {
          callbacks: {
            label: (ctx) => (ctx.raw.y === 1 ? "ON" : "OFF")
          }
        }
      }
    }
  });

  async function refresh() {
    const drv = driverSel.value;
    const points = await loadTxt(drv);
    chart.data.datasets[0].data = points;
    chart.update();
    updateLast(points);
  }

  btnReload.addEventListener("click", () => refresh().catch(e => alert(e.message)));
  btnReset.addEventListener("click", () => chart.resetZoom());
  driverSel.addEventListener("change", () => refresh().catch(e => alert(e.message)));

  refresh().catch(e => alert(e.message));
</script>
</body>
</html>
