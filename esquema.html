<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Esquema sala de calderas</title>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; }
    header {
      position: sticky; top: 0; z-index: 10;
      background: white;
      border-bottom: 1px solid #e5e5e5;
      padding: 10px 12px;
      display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    }
    h1 { font-size: 16px; margin: 0; }
    .btn {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      text-decoration: none;
      color: #111;
      font-weight: 600;
    }
    .btn-red {
      background: #d90000;
      border-color: #b30000;
      color: #fff;
    }
    .hint { font-size: 13px; color: #555; }
    #viewer {
      width: 100vw;
      height: calc(100vh - 58px);
      overflow: hidden;
      background: #fafafa;
    }
    #svgHost {
      width: 100%;
      height: 100%;
    }
    /* El SVG embebido ocupa todo y permite zoom */
    #svgHost svg {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>

<body>
  <header>
    <h1>Esquema (zoom y pan)</h1>
    <a class="btn" href="index.html">⬅ Volver a gráficas</a>
    <button class="btn btn-red" onclick="reloadSvg()">Recargar</button>
    <button class="btn" onclick="zoomIn()">Zoom +</button>
    <button class="btn" onclick="zoomOut()">Zoom -</button>
    <button class="btn" onclick="resetView()">Reset</button>
    <span class="hint" id="status">Cargando…</span>
  </header>

  <div id="viewer">
    <div id="svgHost"></div>
  </div>

  <!-- Librería para zoom/pan en SVG -->
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>

  <script>
    let panZoom = null;

    async function loadSvgText() {
      // cache-buster para forzar la versión nueva
      const url = "esquema_render.svg?v=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("No puedo cargar esquema_render.svg (" + res.status + ")");
      return await res.text();
    }

    async function reloadSvg() {
      const status = document.getElementById("status");
      status.textContent = "Cargando esquema…";

      // Cargar SVG
      const svgText = await loadSvgText();
      const host = document.getElementById("svgHost");
      host.innerHTML = svgText;

      const svgEl = host.querySelector("svg");
      if (!svgEl) throw new Error("El archivo no parece un SVG válido.");

      // Asegura que sea responsive: si no tiene viewBox, se lo intentamos poner
      // (muchos SVG de draw.io lo traen ya)
      if (!svgEl.getAttribute("viewBox")) {
        const w = svgEl.getAttribute("width");
        const h = svgEl.getAttribute("height");
        if (w && h) svgEl.setAttribute("viewBox", `0 0 ${parseFloat(w)} ${parseFloat(h)}`);
      }
      svgEl.removeAttribute("width");
      svgEl.removeAttribute("height");

      // Reiniciar panZoom si ya existía
      if (panZoom) {
        try { panZoom.destroy(); } catch(e) {}
        panZoom = null;
      }

      // Activar zoom/pan
      panZoom = svgPanZoom(svgEl, {
        zoomEnabled: true,
        controlIconsEnabled: false,
        fit: true,
        center: true,
        minZoom: 0.2,
        maxZoom: 20,
        zoomScaleSensitivity: 0.25,
        dblClickZoomEnabled: true
      });

      status.textContent = "OK · " + new Date().toLocaleString();
    }

    function zoomIn()  { if (panZoom) panZoom.zoomIn(); }
    function zoomOut() { if (panZoom) panZoom.zoomOut(); }
    function resetView() { if (panZoom) { panZoom.resetZoom(); panZoom.center(); panZoom.fit(); } }

    // Carga inicial
    reloadSvg().catch(err => {
      document.getElementById("status").textContent = "ERROR: " + err.message;
      console.error(err);
    });

    // Auto-recarga cada 60s (puedes subirlo/bajarlo)
    setInterval(() => {
      reloadSvg().catch(err => console.error(err));
    }, 60000);
  </script>
</body>
</html>
