<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Esquema sala de calderas</title>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; }
    header{
      position: sticky; top: 0; z-index: 50;
      background: #fff;
      border-bottom: 1px solid #e5e5e5;
      padding: 10px 12px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    h1 { font-size: 16px; margin: 0; }
    .btn{
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      text-decoration: none;
      color: #111;
      font-weight: 600;
      user-select: none;
    }
    .btn-red{
      background:#d90000; border-color:#b30000; color:#fff;
    }
    .btn-on{
      outline: 3px solid rgba(217,0,0,.25);
      border-color:#d90000;
    }
    .hint { font-size: 13px; color: #555; }
    .spacer { flex: 1; }
    .badge{ padding:4px 10px; border-radius:999px; background:#f1f1f1; }

    /* Contenedor con scroll H y V */
    #viewport{
      width: 100vw;
      height: calc(100vh - 58px);
      overflow: auto;
      background: #fafafa;
      position: relative;
    }

    /* ‚ÄúLienzo‚Äù del esquema */
    #svgHost{
      position: relative;
      display: inline-block;
      padding: 12px;
      transform-origin: 0 0; /* zoom desde esquina */
    }

    /* El SVG no se limita al ancho pantalla */
    #svgHost svg{
      display: block;
      height: auto;
      max-width: none;
      pointer-events: none; /* para que el scroll/zoom vaya suave */
      user-select: none;
    }

    /* Lupa */
    #loupe{
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 280px;
      height: 220px;
      border: 2px solid #d90000;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 8px 18px rgba(0,0,0,0.2);
      display: none;
      overflow: hidden;
      z-index: 100;
    }
    #loupeHeader{
      background: #d90000;
      color: #fff;
      font-weight: 800;
      font-size: 13px;
      padding: 6px 10px;
      display:flex;
      justify-content: space-between;
      align-items: center;
    }
    #loupeBody{
      width: 100%;
      height: calc(100% - 30px);
      position: relative;
      background: #fff;
    }
    #loupeSvgWrap{
      position: absolute;
      left: 0; top: 0;
      transform-origin: 0 0;
      pointer-events: none;
    }
    .small { font-size: 12px; font-weight: 650; opacity: .95; }
  </style>
</head>

<body>
  <header>
    <h1>Esquema</h1>
    <a class="btn" href="index.html">‚¨Ö Volver a gr√°ficas</a>

    <button class="btn btn-red" onclick="reloadSvg()">Recargar</button>

    <button id="btnLoupe" class="btn" onclick="toggleLoupe()">üîé Lupa</button>
    <span class="hint small" id="loupeHint" style="display:none;">(click para fijar)</span>

    <button class="btn" onclick="zoomIn()">Zoom +</button>
    <button class="btn" onclick="zoomOut()">Zoom -</button>
    <button class="btn" onclick="resetZoom()">Reset</button>

    <span class="spacer"></span>
    <span class="hint badge" id="status">Cargando‚Ä¶</span>
  </header>

  <div id="viewport">
    <div id="svgHost">Cargando esquema‚Ä¶</div>
  </div>

  <!-- Lupa -->
  <div id="loupe">
    <div id="loupeHeader">
      <span>üîé Lupa</span>
      <span class="small" id="loupeMode">SIGUE</span>
    </div>
    <div id="loupeBody">
      <div id="loupeSvgWrap"></div>
    </div>
  </div>

  <script>
    // IMPORTANTE:
    // Si esquema.html y esquema_render.svg est√°n en la MISMA carpeta, esto vale.
    // Si no lo ves, casi siempre es que est√°n en carpetas distintas.
    const SVG_FILE = "esquema_render.svg";

    // Zoom general
    let zoom = 1.0;
    const ZOOM_MIN = 0.25;
    const ZOOM_MAX = 6.0;
    const ZOOM_STEP = 0.15;

    // Lupa
    let loupeOn = false;
    let loupeLocked = false;        // click fija/desfija
    const LOUPE_SCALE = 2.8;        // zoom dentro de la lupa

    let svgTextCache = "";
    let svgLoaded = false;

    function setStatus(t){ document.getElementById("status").textContent = t; }
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function applyZoom(){
      const host = document.getElementById("svgHost");
      host.style.transform = `scale(${zoom})`;
    }

    function zoomIn(){ zoom = clamp(zoom + ZOOM_STEP, ZOOM_MIN, ZOOM_MAX); applyZoom(); }
    function zoomOut(){ zoom = clamp(zoom - ZOOM_STEP, ZOOM_MIN, ZOOM_MAX); applyZoom(); }
    function resetZoom(){ zoom = 1.0; applyZoom(); }

    async function fetchSvgText(){
      const url = SVG_FILE + "?v=" + Date.now(); // cache-buster
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) {
        throw new Error(`No puedo cargar ${SVG_FILE} (HTTP ${res.status}). Revisa que exista en la misma carpeta que esquema.html.`);
      }
      return await res.text();
    }

    function mountSvg(svgText){
      const host = document.getElementById("svgHost");
      host.innerHTML = svgText;
      const svg = host.querySelector("svg");
      if (!svg) throw new Error("El fichero no parece un SVG v√°lido.");

      // No forzamos width/height: dejamos el tama√±o natural para scroll
      svg.removeAttribute("width");
      svg.removeAttribute("height");
      svg.style.maxWidth = "none";

      // Montar copia en la lupa
      const loupeWrap = document.getElementById("loupeSvgWrap");
      loupeWrap.innerHTML = svgText;
      const lsvg = loupeWrap.querySelector("svg");
      if (lsvg){
        lsvg.removeAttribute("width");
        lsvg.removeAttribute("height");
        lsvg.style.maxWidth = "none";
      }

      svgTextCache = svgText;
      svgLoaded = true;
      applyZoom();
    }

    async function reloadSvg(){
      try{
        setStatus("Cargando SVG‚Ä¶");
        const txt = await fetchSvgText();
        mountSvg(txt);
        setStatus("OK ¬∑ " + new Date().toLocaleString());
      }catch(e){
        console.error(e);
        svgLoaded = false;
        document.getElementById("svgHost").innerHTML =
          `<div style="padding:14px; color:#b30000; font-weight:700">
             ERROR: ${e.message}<br><br>
             ‚úÖ Comprueba que <b>${SVG_FILE}</b> existe en el repo y est√° en la misma carpeta que <b>esquema.html</b>.<br>
             (Ejemplo URL directa): <a href="${SVG_FILE}" target="_blank">${SVG_FILE}</a>
           </div>`;
        setStatus("ERROR");
      }
    }

    function toggleLoupe(){
      loupeOn = !loupeOn;
      loupeLocked = false;

      const loupe = document.getElementById("loupe");
      const btn = document.getElementById("btnLoupe");
      const hint = document.getElementById("loupeHint");

      loupe.style.display = loupeOn ? "block" : "none";
      btn.classList.toggle("btn-on", loupeOn);
      hint.style.display = loupeOn ? "inline" : "none";

      document.getElementById("loupeMode").textContent = "SIGUE";

      if (loupeOn) setStatus("Lupa activada (click para fijar)");
      else setStatus("Lupa desactivada");
    }

    function toggleLoupeLock(){
      if (!loupeOn) return;
      loupeLocked = !loupeLocked;
      document.getElementById("loupeMode").textContent = loupeLocked ? "FIJA" : "SIGUE";
      setStatus(loupeLocked ? "Lupa fija" : "Lupa siguiendo cursor");
    }

    function updateLoupe(clientX, clientY){
      if (!loupeOn || !svgLoaded || loupeLocked) return;

      const viewport = document.getElementById("viewport");
      const host = document.getElementById("svgHost");
      const loupeWrap = document.getElementById("loupeSvgWrap");
      const loupeBody = document.getElementById("loupeBody");

      const vpRect = viewport.getBoundingClientRect();

      // Coordenadas del puntero dentro del viewport + scroll
      const xInViewport = clientX - vpRect.left + viewport.scrollLeft;
      const yInViewport = clientY - vpRect.top  + viewport.scrollTop;

      // Posici√≥n del host dentro del viewport (con scroll)
      const hostRect = host.getBoundingClientRect();
      const hostLeft = (hostRect.left - vpRect.left) + viewport.scrollLeft;
      const hostTop  = (hostRect.top  - vpRect.top)  + viewport.scrollTop;

      // Coordenadas dentro del host, PERO el host est√° escalado (zoom general)
      // As√≠ que ‚Äúdes-escalamos‚Äù para apuntar bien al contenido real.
      const hostX = (xInViewport - hostLeft) / zoom;
      const hostY = (yInViewport - hostTop)  / zoom;

      const lw = loupeBody.clientWidth;
      const lh = loupeBody.clientHeight;

      const tx = -(hostX * LOUPE_SCALE) + lw/2;
      const ty = -(hostY * LOUPE_SCALE) + lh/2;

      loupeWrap.style.transform = `translate(${tx}px, ${ty}px) scale(${LOUPE_SCALE})`;
    }

    // Scroll + zoom con rueda: Ctrl+rueda hace zoom (para no molestar el scroll normal)
    // Si quieres zoom SIEMPRE con rueda, te lo cambio.
    document.getElementById("viewport").addEventListener("wheel", (e) => {
      // Si mantienes CTRL, hacemos zoom general
      if (e.ctrlKey) {
        e.preventDefault();
        const delta = Math.sign(e.deltaY);
        zoom = clamp(zoom + (delta > 0 ? -ZOOM_STEP : ZOOM_STEP), ZOOM_MIN, ZOOM_MAX);
        applyZoom();
      }
    }, { passive: false });

    // Mover la lupa con el rat√≥n o touch
    document.getElementById("viewport").addEventListener("mousemove", (e) => updateLoupe(e.clientX, e.clientY));
    document.getElementById("viewport").addEventListener("touchmove", (e) => {
      if (e.touches && e.touches[0]) updateLoupe(e.touches[0].clientX, e.touches[0].clientY);
    }, { passive: true });

    // Click en el viewport: fija/desfija la lupa
    document.getElementById("viewport").addEventListener("click", () => toggleLoupeLock());

    // Carga inicial + auto-recarga
    reloadSvg();
    setInterval(reloadSvg, 60000);
  </script>
</body>
</html>
