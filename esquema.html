<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Esquema sala de calderas</title>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; }
    header{
      position: sticky; top: 0; z-index: 50;
      background: #fff;
      border-bottom: 1px solid #e5e5e5;
      padding: 10px 12px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    h1 { font-size: 16px; margin: 0; }
    .btn{
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      text-decoration: none;
      color: #111;
      font-weight: 600;
      user-select: none;
    }
    .btn-red{
      background:#d90000; border-color:#b30000; color:#fff;
    }
    .btn-on{
      outline: 3px solid rgba(217,0,0,.25);
      border-color:#d90000;
    }
    .hint { font-size: 13px; color: #555; }
    .spacer { flex: 1; }

    /* Contenedor con scroll en ambas direcciones */
    #viewport{
      width: 100vw;
      height: calc(100vh - 58px);
      overflow: auto;                /* <-- scroll H y V */
      background: #fafafa;
      position: relative;
    }

    /* El SVG lo ponemos dentro de un "canvas" para que pueda ser mÃ¡s grande que la pantalla */
    #svgHost{
      position: relative;
      display: inline-block;         /* para que el ancho sea el del contenido */
      padding: 12px;
    }

    /* El SVG NO lo forzamos a 100% aquÃ­, para que el scroll tenga sentido */
    #svgHost svg{
      display: block;
      height: auto;
      max-width: none;               /* <-- permite que sea mÃ¡s ancho que la pantalla */
    }

    /* Lupa */
    #loupe{
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 260px;
      height: 200px;
      border: 2px solid #d90000;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 8px 18px rgba(0,0,0,0.2);
      display: none;                 /* se muestra al activar */
      overflow: hidden;
      z-index: 100;
    }
    #loupeHeader{
      background: #d90000;
      color: #fff;
      font-weight: 700;
      font-size: 13px;
      padding: 6px 10px;
      display:flex;
      justify-content: space-between;
      align-items: center;
    }
    #loupeBody{
      width: 100%;
      height: calc(100% - 30px);
      position: relative;
      background: #fff;
    }
    #loupeSvgWrap{
      position: absolute;
      left: 0; top: 0;
      transform-origin: 0 0;
    }

    /* pequeÃ±o indicador de estado */
    .badge{ padding:4px 10px; border-radius:999px; background:#f1f1f1; }
  </style>
</head>

<body>
  <header>
    <h1>Esquema</h1>
    <a class="btn" href="index.html">â¬… Volver a grÃ¡ficas</a>
    <button class="btn btn-red" onclick="reloadSvg()">Recargar</button>

    <button id="btnLoupe" class="btn" onclick="toggleLoupe()">ðŸ”Ž Lupa</button>

    <span class="spacer"></span>
    <span class="hint badge" id="status">Cargandoâ€¦</span>
  </header>

  <div id="viewport">
    <div id="svgHost">Cargando esquemaâ€¦</div>
  </div>

  <!-- Lupa -->
  <div id="loupe">
    <div id="loupeHeader">
      <span>ðŸ”Ž Lupa</span>
      <button class="btn" style="padding:4px 8px;border-radius:8px" onclick="toggleLoupe()">Cerrar</button>
    </div>
    <div id="loupeBody">
      <div id="loupeSvgWrap"></div>
    </div>
  </div>

  <script>
    const SVG_URL = "esquema_render.svg";

    let loupeOn = false;
    let svgEl = null;          // SVG en la pÃ¡gina principal
    let loupeSvgEl = null;     // SVG duplicado dentro de la lupa
    const LOUPE_SCALE = 2.8;   // zoom de la lupa (sube/baja a gusto)

    function setStatus(text){ document.getElementById("status").textContent = text; }

    async function reloadSvg(){
      try{
        setStatus("Cargandoâ€¦");
        const url = SVG_URL + "?v=" + Date.now();   // cache-buster
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("No puedo cargar SVG (" + res.status + ")");
        const svgText = await res.text();

        // Insertar SVG
        const host = document.getElementById("svgHost");
        host.innerHTML = svgText;
        svgEl = host.querySelector("svg");
        if (!svgEl) throw new Error("El fichero no parece un SVG vÃ¡lido.");

        // Quitar width/height para que el tamaÃ±o sea "natural" (y el scroll funcione)
        // Si el SVG trae viewBox, perfecto.
        svgEl.removeAttribute("width");
        svgEl.removeAttribute("height");
        svgEl.style.maxWidth = "none";

        // Preparar lupa (duplicado del SVG dentro de la lupa)
        const loupeWrap = document.getElementById("loupeSvgWrap");
        loupeWrap.innerHTML = svgText;
        loupeSvgEl = loupeWrap.querySelector("svg");
        if (loupeSvgEl){
          loupeSvgEl.removeAttribute("width");
          loupeSvgEl.removeAttribute("height");
          loupeSvgEl.style.maxWidth = "none";
        }

        setStatus("OK Â· " + new Date().toLocaleString());
      }catch(e){
        console.error(e);
        setStatus("ERROR: " + e.message);
      }
    }

    function toggleLoupe(){
      loupeOn = !loupeOn;
      const loupe = document.getElementById("loupe");
      const btn = document.getElementById("btnLoupe");
      loupe.style.display = loupeOn ? "block" : "none";
      btn.classList.toggle("btn-on", loupeOn);

      if (loupeOn) setStatus("Lupa activada (mueve el ratÃ³n sobre el esquema)");
      else setStatus("Lupa desactivada");
    }

    function updateLoupe(clientX, clientY){
      if (!loupeOn || !svgEl || !loupeSvgEl) return;

      const viewport = document.getElementById("viewport");
      const host = document.getElementById("svgHost");
      const loupeWrap = document.getElementById("loupeSvgWrap");
      const loupeBody = document.getElementById("loupeBody");

      // Coordenadas del ratÃ³n dentro del viewport (teniendo en cuenta scroll)
      const vpRect = viewport.getBoundingClientRect();
      const xInViewport = clientX - vpRect.left + viewport.scrollLeft;
      const yInViewport = clientY - vpRect.top  + viewport.scrollTop;

      // Coordenadas dentro del host (por si hay padding)
      const hostRect = host.getBoundingClientRect();
      const hostX = xInViewport - (hostRect.left - vpRect.left + viewport.scrollLeft);
      const hostY = yInViewport - (hostRect.top  - vpRect.top  + viewport.scrollTop);

      // Centrar la zona en la lupa
      const lw = loupeBody.clientWidth;
      const lh = loupeBody.clientHeight;

      const tx = -(hostX * LOUPE_SCALE) + lw/2;
      const ty = -(hostY * LOUPE_SCALE) + lh/2;

      loupeWrap.style.transform = `translate(${tx}px, ${ty}px) scale(${LOUPE_SCALE})`;
    }

    // Mouse move sobre el viewport -> mueve la lupa
    document.getElementById("viewport").addEventListener("mousemove", (e) => {
      updateLoupe(e.clientX, e.clientY);
    });

    // En mÃ³vil: con el dedo (touch)
    document.getElementById("viewport").addEventListener("touchmove", (e) => {
      if (!e.touches || !e.touches[0]) return;
      updateLoupe(e.touches[0].clientX, e.touches[0].clientY);
    }, { passive: true });

    // Carga inicial
    reloadSvg();

    // Auto-recarga cada 60s
    setInterval(reloadSvg, 60000);
  </script>
</body>
</html>
