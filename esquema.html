<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Esquema BMS · Sala de Calderas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --fg-dark:#e5e7eb;
  --fg-light:#0f172a;
  --line:#1e293b;
  --ok:#22c55e;
  --bad:#ef4444;
  --accent:#38bdf8;
}

/* ===== FONDO SEGÚN DISPOSITIVO ===== */

/* MÓVIL / TABLET */
@media (max-width: 900px){
  body{ background:#000; color:var(--fg-dark); }
  header{ background:#020617; }
  #viewer{ background:#000; }
}

/* ORDENADOR */
@media (min-width: 901px){
  body{ background:#fff; color:var(--fg-light); }
  header{ background:#f8fafc; }
  #viewer{ background:#fff; }
}

body{
  margin:0;
  font-family: system-ui, Arial, sans-serif;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  padding:8px 12px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  gap:10px;
}

header b{ font-size:14px; }

button{
  padding:6px 10px;
  font-size:13px;
  border:1px solid var(--line);
  border-radius:8px;
  background:transparent;
  cursor:pointer;
}

#status{
  margin-left:auto;
  font-size:12px;
  color:#64748b;
}

/* ===== LAYOUT ===== */
#viewer{
  width:100vw;
  height: calc(100vh - 48px);
  overflow:auto;
}

#svgObj{
  display:block;
  transform-origin: top left;
}

/* ===== PANEL ESTADO ===== */
#panel{
  position:fixed;
  right:10px;
  bottom:10px;
  width:360px;
  max-height:65vh;
  overflow:auto;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  background:rgba(2,6,23,.92);
  color:#e5e7eb;
  font-size:12px;
}

#panel h4{
  margin:8px 0 6px;
  font-size:12px;
  color:var(--accent);
  font-weight:800;
}

.time{
  font-size:11px;
  color:#cbd5f5;
  margin-bottom:6px;
}

.row{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:5px 0;
  border-bottom:1px dashed #1e293b;
}
.row:last-child{ border-bottom:none; }

.left{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.item{
  font-size:11px;
  color:#94a3b8;
  font-weight:700;
}
.label{
  font-size:12px;
  color:#e5e7eb;
}

.on{ color:var(--ok); font-weight:800; }
.off{ color:var(--bad); font-weight:800; }
</style>
</head>

<body>

<header>
  <b>Esquema BMS · Sala de Calderas</b>

  <button onclick="zoomIn()">Zoom +</button>
  <button onclick="zoomOut()">Zoom −</button>
  <button onclick="fit()">Ajustar</button>

  <span id="status">Cargando…</span>
</header>

<div id="viewer">
  <object id="svgObj" type="image/svg+xml" data="esquema_render.svg"></object>
</div>

<!-- PANEL ESTADO -->
<div id="panel">
  <div class="time" id="lastUpdate">Última actualización: —</div>

  <h4>Sensores</h4>
  <div id="panelS"></div>

  <h4>Drivers</h4>
  <div id="panelD"></div>
</div>

<script>
/* ===== ZOOM ===== */
const obj = document.getElementById("svgObj");
const viewer = document.getElementById("viewer");
const statusEl = document.getElementById("status");

let scale = 1;

function applyZoom(){
  obj.style.transform = `scale(${scale})`;
  statusEl.textContent = `Zoom ${Math.round(scale*100)}%`;
}
function zoomIn(){ scale=Math.min(scale*1.15,6); applyZoom(); }
function zoomOut(){ scale=Math.max(scale/1.15,0.2); applyZoom(); }

function fit(){
  const svg = obj.contentDocument?.documentElement;
  if(!svg) return;
  const vb = svg.viewBox.baseVal;
  const iw = vb.width || svg.getBoundingClientRect().width;
  const ih = vb.height || svg.getBoundingClientRect().height;
  const vw = viewer.clientWidth;
  const vh = viewer.clientHeight;
  scale = Math.min(vw/iw, vh/ih)*0.97;
  applyZoom();
  viewer.scrollTop = viewer.scrollLeft = 0;
}

/* ===== RECOLOR SOLO NEGRO ===== */
function recolorSVG(){
  const svg = obj.contentDocument;
  if(!svg) return;
  svg.querySelectorAll("*").forEach(el=>{
    const s = el.getAttribute("stroke");
    const f = el.getAttribute("fill");
    if(s && ["#000","#000000","black"].includes(s)) el.setAttribute("stroke","#ffffff");
    if(el.tagName==="text" && f && ["#000","#000000","black"].includes(f)) el.setAttribute("fill","#ffffff");
  });
}

/* ===== ESTADO DESDE latest_all.json (CON LABELS) ===== */
const JSONS=[
  "sensores/data/latest_all.json",
  "data/latest_all.json"
];

async function loadJSON(){
  let data=null;
  for(const u of JSONS){
    try{
      const r=await fetch(u,{cache:"no-store"});
      if(r.ok){ data=await r.json(); break; }
    }catch{}
  }
  if(!data) return;

  document.getElementById("lastUpdate").textContent =
    "Última actualización: "+new Date(data.timestamp_utc).toLocaleString();

  const sBox=document.getElementById("panelS");
  const dBox=document.getElementById("panelD");
  sBox.innerHTML=""; dBox.innerHTML="";

  /* SENSORES */
  data.sensors?.forEach(s=>{
    sBox.innerHTML+=`
      <div class="row">
        <div class="left">
          <div class="label">${s.label || s.item}</div>
          <div class="item">${s.item}</div>
        </div>
        <div>${s.value} ${s.units||""}</div>
      </div>`;
  });

  /* DRIVERS */
  data.drivers?.forEach(d=>{
    const on = String(d.value).toLowerCase()==="on" || d.value==1;
    dBox.innerHTML+=`
      <div class="row">
        <div class="left">
          <div class="label">${d.label || d.item}</div>
          <div class="item">${d.item}</div>
        </div>
        <div class="${on?"on":"off"}">${on?"ON":"OFF"}</div>
      </div>`;
  });
}

/* ===== INIT ===== */
obj.onload=()=>{
  statusEl.textContent="SVG cargado";
  recolorSVG();
  fit();
};
obj.onerror=()=>statusEl.textContent="ERROR SVG";

loadJSON();
setInterval(loadJSON,30000);
</script>

</body>
</html>
